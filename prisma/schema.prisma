generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                 String                   @id @default(cuid())
  name               String?
  email              String?                  @unique
  emailVerified      DateTime?
  image              String?
  role               String                   @default("user") // "user" | "admin"
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  accounts           Account[]
  boards             Board[]
  lessons            Lesson[]
  sessions           Session[]
  tutorSessions      TutorSession[]
  savedPosts         SavedPost[]
  journeyProgress    JourneyProgress[]
  lessonProgress     UserLessonProgress[]
  exerciseAttempts   ExerciseAttempt[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Lesson {
  id        String   @id @default(cuid())
  userId    String
  module    String
  title     String
  content   String
  progress  Float    @default(0)
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TutorSession {
  id        String   @id @default(cuid())
  userId    String
  messages  String
  language  String   @default("mk")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Board {
  id        String   @id @default(cuid())
  userId    String
  name      String   @default("My Tasks")
  columns   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SavedPost {
  id           String   @id @default(cuid())
  userId       String
  instagramId  String
  caption      String   @db.Text
  mediaUrl     String
  mediaType    String
  thumbnailUrl String?
  permalink    String
  timestamp    DateTime
  savedAt      DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, instagramId])
  @@index([userId, savedAt])
}

model Tag {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  color     String    @default("#3b82f6")
  icon      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  postTags  PostTag[]

  @@index([slug])
}

model PostTag {
  id          String   @id @default(cuid())
  instagramId String
  tagId       String
  createdAt   DateTime @default(now())
  tag         Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([instagramId, tagId])
  @@index([instagramId])
  @@index([tagId])
}

// Journey progress tracking (moved from localStorage to DB)
model JourneyProgress {
  id               String    @id @default(cuid())
  userId           String
  journeyId        String    // 'family' | 'travel' | 'culture'
  isActive         Boolean   @default(false)
  currentModuleId  String?
  currentLessonId  String?
  dailyGoalMinutes Int       @default(20)
  streakCount      Int       @default(0)
  lastSessionDate  DateTime?
  totalMinutes     Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentModule Module?  @relation("CurrentModule", fields: [currentModuleId], references: [id])
  currentLesson CurriculumLesson? @relation("CurrentLesson", fields: [currentLessonId], references: [id])

  @@unique([userId, journeyId])
  @@index([userId, isActive])
}

// Modules organize lessons into themed collections
model Module {
  id          String             @id @default(cuid())
  journeyId   String             // 'family' | 'travel' | 'culture'
  title       String
  description String             @db.Text
  orderIndex  Int
  lessons     CurriculumLesson[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  activeInJourneys JourneyProgress[] @relation("CurrentModule")

  @@unique([journeyId, orderIndex])
  @@index([journeyId, orderIndex])
}

// Curriculum lessons (structured content created by Andri)
model CurriculumLesson {
  id               String   @id @default(cuid())
  moduleId         String
  title            String
  summary          String?  @db.Text
  content          String   @db.Text
  orderIndex       Int
  estimatedMinutes Int      @default(15)
  difficultyLevel  String   @default("beginner") // beginner|intermediate|advanced
  audioUrl         String?
  videoUrl         String?

  // Content sections
  vocabularyItems VocabularyItem[]
  grammarNotes    GrammarNote[]
  exercises       Exercise[]

  // Relations
  module       Module                   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  userProgress UserLessonProgress[]

  activeInJourneys JourneyProgress[] @relation("CurrentLesson")

  @@unique([moduleId, orderIndex])
  @@index([moduleId, orderIndex])
}

// Track user progress per lesson
model UserLessonProgress {
  id           String    @id @default(cuid())
  userId       String
  lessonId     String
  status       String    @default("not_started") // not_started|in_progress|completed
  progress     Float     @default(0) // 0-100
  timeSpent    Int       @default(0) // minutes
  lastViewedAt DateTime?
  completedAt  DateTime?

  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson CurriculumLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId])
  @@index([userId, status])
}

// Vocabulary items in lessons
model VocabularyItem {
  id                 String   @id @default(cuid())
  lessonId           String
  macedonianText     String
  englishText        String
  pronunciation      String?
  audioUrl           String?
  exampleSentenceMk  String?  @db.Text
  exampleSentenceEn  String?  @db.Text
  orderIndex         Int

  lesson CurriculumLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([lessonId, orderIndex])
}

// Grammar explanations
model GrammarNote {
  id          String   @id @default(cuid())
  lessonId    String
  title       String
  explanation String   @db.Text
  examples    String   @db.Text // JSON array of examples
  orderIndex  Int

  lesson CurriculumLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([lessonId, orderIndex])
}

// Interactive exercises
model Exercise {
  id            String   @id @default(cuid())
  lessonId      String
  type          String   // 'multiple_choice' | 'fill_blank' | 'translation' | 'matching'
  question      String   @db.Text
  options       String   @db.Text // JSON array
  correctAnswer String   @db.Text
  explanation   String?  @db.Text
  orderIndex    Int

  lesson       CurriculumLesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  userAttempts ExerciseAttempt[]

  createdAt DateTime @default(now())

  @@index([lessonId, orderIndex])
}

// Track user exercise attempts
model ExerciseAttempt {
  id          String   @id @default(cuid())
  userId      String
  exerciseId  String
  userAnswer  String   @db.Text
  isCorrect   Boolean
  attemptedAt DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([userId, exerciseId])
  @@index([userId, attemptedAt])
}

// Word of the Day - managed by admins
model WordOfTheDay {
  id             String   @id @default(cuid())
  macedonian     String
  pronunciation  String
  english        String
  partOfSpeech   String   // noun, verb, adjective, etc.
  exampleMk      String   @db.Text
  exampleEn      String   @db.Text
  icon           String   // emoji icon
  scheduledDate  DateTime @unique // date this word should appear
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([scheduledDate, isActive])
  @@index([isActive])
}

// Practice Vocabulary - word bank for Quick Practice exercises
model PracticeVocabulary {
  id             String    @id @default(cuid())
  macedonian     String
  english        String
  category       String?   // Optional category (e.g., "food", "family", "greetings")
  difficulty     String    @default("beginner") // beginner | intermediate | advanced
  formality      String    @default("neutral") // formal | neutral | informal
  isActive       Boolean   @default(true)

  // Word of the Day fields (optional - only needed if includeInWOTD is true)
  includeInWOTD  Boolean   @default(false) // Flag to indicate if this should appear as WOTD
  pronunciation  String?   // Pronunciation guide (e.g., "zdravo")
  partOfSpeech   String?   // noun, verb, adjective, etc.
  exampleMk      String?   @db.Text // Example sentence in Macedonian
  exampleEn      String?   @db.Text // Example sentence in English
  icon           String?   // Emoji icon
  scheduledDate  DateTime? @unique // Date this word should appear as WOTD
  usageContext   String?   @db.Text // Usage context and situational notes

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([isActive, difficulty])
  @@index([category])
  @@index([includeInWOTD, scheduledDate])
  @@index([formality])
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                   String                  @id @default(cuid())
  name                 String?
  email                String?                 @unique
  emailVerified        DateTime?
  password             String? // Hashed password (optional for OAuth users)
  image                String?
  role                 String                  @default("user") // "user" | "admin"
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  accounts             Account[]
  boards               Board[]
  lessons              Lesson[]
  sessions             Session[]
  tutorSessions        TutorSession[]
  savedPosts           SavedPost[]
  journeyProgress      JourneyProgress[]
  lessonProgress       UserLessonProgress[]
  exerciseAttempts     ExerciseAttempt[]
  gameProgress         GameProgress?
  mobilePushTokens     MobilePushToken[]
  mission              Mission?
  questProgress        UserQuestProgress[]
  badges               UserBadge[]
  currency             Currency?
  currencyTransactions CurrencyTransaction[]
  leagueMemberships    LeagueMembership[]
  notifications        Notification[]
  reminderSettings     ReminderSettings?
  customDecks          CustomDeck[]
  friendRequestsSent     Friendship[] @relation("FriendRequestsSent")
  friendRequestsReceived Friendship[] @relation("FriendRequestsReceived")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model MobilePushToken {
  id                   String             @id @default(cuid())
  userId               String?
  expoPushToken        String             @unique
  platform             MobilePushPlatform
  appVersion           String?
  locale               String?
  timezone             String?
  reminderWindows      String[]           @default([])
  lastSuccessfulSync   DateTime?
  lastReminderSentAt   DateTime?
  lastReminderWindowId String?
  revokedAt            DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum MobilePushPlatform {
  ios
  android
}

model Lesson {
  id        String   @id @default(cuid())
  userId    String
  module    String
  title     String
  content   String
  progress  Float    @default(0)
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TutorSession {
  id        String   @id @default(cuid())
  userId    String
  messages  String
  language  String   @default("mk")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Board {
  id        String   @id @default(cuid())
  userId    String
  name      String   @default("My Tasks")
  columns   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SavedPost {
  id           String   @id @default(cuid())
  userId       String
  instagramId  String
  caption      String   @db.Text
  mediaUrl     String
  mediaType    String
  thumbnailUrl String?
  permalink    String
  timestamp    DateTime
  savedAt      DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, instagramId])
  @@index([userId, savedAt])
}

model Tag {
  id        String    @id @default(cuid())
  name      String    @unique
  slug      String    @unique
  color     String    @default("#3b82f6")
  icon      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  postTags  PostTag[]

  @@index([slug])
}

model PostTag {
  id          String   @id @default(cuid())
  instagramId String
  tagId       String
  createdAt   DateTime @default(now())
  tag         Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([instagramId, tagId])
  @@index([instagramId])
  @@index([tagId])
}

// Journey progress tracking (moved from localStorage to DB)
model JourneyProgress {
  id               String    @id @default(cuid())
  userId           String
  journeyId        String // 'family' | 'travel' | 'culture'
  isActive         Boolean   @default(false)
  currentModuleId  String?
  currentLessonId  String?
  dailyGoalMinutes Int       @default(20)
  streakCount      Int       @default(0)
  lastSessionDate  DateTime?
  totalMinutes     Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentModule Module?           @relation("CurrentModule", fields: [currentModuleId], references: [id])
  currentLesson CurriculumLesson? @relation("CurrentLesson", fields: [currentLessonId], references: [id])

  @@unique([userId, journeyId])
  @@index([userId, isActive])
}

// Modules organize lessons into themed collections
model Module {
  id          String             @id @default(cuid())
  journeyId   String // 'family' | 'travel' | 'culture'
  title       String
  description String             @db.Text
  orderIndex  Int
  lessons     CurriculumLesson[]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  activeInJourneys JourneyProgress[] @relation("CurrentModule")

  @@unique([journeyId, orderIndex])
  @@index([journeyId, orderIndex])
}

// Curriculum lessons (structured content created by Andri)
model CurriculumLesson {
  id               String  @id @default(cuid())
  moduleId         String
  title            String
  summary          String? @db.Text
  content          String  @db.Text
  orderIndex       Int
  estimatedMinutes Int     @default(15)
  difficultyLevel  String  @default("beginner") // beginner|intermediate|advanced
  audioUrl         String?
  videoUrl         String?

  // Content sections
  vocabularyItems VocabularyItem[]
  grammarNotes    GrammarNote[]
  exercises       Exercise[]

  // Relations
  module       Module               @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  userProgress UserLessonProgress[]

  activeInJourneys JourneyProgress[] @relation("CurrentLesson")

  @@unique([moduleId, orderIndex])
  @@index([moduleId, orderIndex])
}

// Track user progress per lesson
model UserLessonProgress {
  id           String    @id @default(cuid())
  userId       String
  lessonId     String
  status       String    @default("not_started") // not_started|in_progress|completed
  progress     Float     @default(0) // 0-100
  timeSpent    Int       @default(0) // minutes
  lastViewedAt DateTime?
  completedAt  DateTime?

  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson CurriculumLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId])
  @@index([userId, status])
}

// Vocabulary items in lessons
model VocabularyItem {
  id                String  @id @default(cuid())
  lessonId          String
  macedonianText    String
  englishText       String
  pronunciation     String?
  audioUrl          String?
  exampleSentenceMk String? @db.Text
  exampleSentenceEn String? @db.Text
  orderIndex        Int

  lesson CurriculumLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([lessonId, orderIndex])
}

// Grammar explanations
model GrammarNote {
  id          String @id @default(cuid())
  lessonId    String
  title       String
  explanation String @db.Text
  examples    String @db.Text // JSON array of examples
  orderIndex  Int

  lesson CurriculumLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([lessonId, orderIndex])
}

// Interactive exercises
model Exercise {
  id            String  @id @default(cuid())
  lessonId      String
  type          String // 'multiple_choice' | 'fill_blank' | 'translation' | 'matching'
  question      String  @db.Text
  options       String  @db.Text // JSON array
  correctAnswer String  @db.Text
  explanation   String? @db.Text
  orderIndex    Int

  lesson       CurriculumLesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  userAttempts ExerciseAttempt[]

  createdAt DateTime @default(now())

  @@index([lessonId, orderIndex])
}

// Track user exercise attempts
model ExerciseAttempt {
  id          String   @id @default(cuid())
  userId      String
  exerciseId  String
  userAnswer  String   @db.Text
  isCorrect   Boolean
  attemptedAt DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([userId, exerciseId])
  @@index([userId, attemptedAt])
}

// Word of the Day - managed by admins
model WordOfTheDay {
  id            String   @id @default(cuid())
  macedonian    String
  pronunciation String
  english       String
  partOfSpeech  String // noun, verb, adjective, etc.
  exampleMk     String   @db.Text
  exampleEn     String   @db.Text
  icon          String // emoji icon
  scheduledDate DateTime @unique // date this word should appear
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([scheduledDate, isActive])
  @@index([isActive])
}

// Practice Vocabulary - word bank for Quick Practice exercises
model PracticeVocabulary {
  id         String  @id @default(cuid())
  macedonian String
  english    String
  category   String? // Optional category (e.g., "food", "family", "greetings")
  difficulty String  @default("beginner") // beginner | intermediate | advanced
  formality  String  @default("neutral") // formal | neutral | informal
  isActive   Boolean @default(true)

  // Word of the Day fields (optional - only needed if includeInWOTD is true)
  includeInWOTD Boolean   @default(false) // Flag to indicate if this should appear as WOTD
  pronunciation String? // Pronunciation guide (e.g., "zdravo")
  partOfSpeech  String? // noun, verb, adjective, etc.
  exampleMk     String?   @db.Text // Example sentence in Macedonian
  exampleEn     String?   @db.Text // Example sentence in English
  icon          String? // Emoji icon
  scheduledDate DateTime? @unique // Date this word should appear as WOTD
  usageContext  String?   @db.Text // Usage context and situational notes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, difficulty])
  @@index([category])
  @@index([includeInWOTD, scheduledDate])
  @@index([formality])
}

model PracticeAudio {
  id          String               @id @default(cuid())
  promptId    String               @unique
  language    String               @default("mk")
  speaker     String?
  speed       String? // normal, slow
  variant     String? // female, male, etc.
  duration    Float?
  status      PracticeAudioStatus  @default(draft)
  sourceType  PracticeAudioSource  @default(human)
  cdnUrl      String
  slowUrl     String?
  waveform    Json?
  notes       String?              @db.Text
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  publishedAt DateTime?

  @@index([promptId])
  @@index([status])
}

enum PracticeAudioStatus {
  draft
  processing
  published
  archived
}

enum PracticeAudioSource {
  human
  tts
}

// Custom Deck - user-created practice decks
model CustomDeck {
  id          String          @id @default(cuid())
  userId      String
  name        String
  description String?         @db.Text
  category    String?
  isArchived  Boolean         @default(false)
  cardCount   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  user  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  cards CustomDeckCard[]

  @@index([userId, isArchived])
  @@index([userId, createdAt])
}

// Custom Deck Card - individual cards in a custom deck
model CustomDeckCard {
  id                   String   @id @default(cuid())
  deckId               String
  macedonian           String
  english              String
  macedonianAlternates String[] @default([])
  englishAlternates    String[] @default([])
  category             String?
  notes                String?  @db.Text
  orderIndex           Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  deck CustomDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)

  @@index([deckId, orderIndex])
  @@index([deckId, createdAt])
}

// Game Progress - gamification data (streak, XP, level, hearts)
model GameProgress {
  id               String    @id @default(cuid())
  userId           String    @unique
  streak           Int       @default(0) // consecutive days of practice
  xp               Int       @default(0) // total experience points
  level            String    @default("beginner") // beginner | intermediate | advanced
  hearts           Int       @default(5) // current heart count (max 5)
  lastPracticeDate DateTime? // last date user practiced (for streak calculation)
  streakUpdatedAt  DateTime? // last time streak was updated
  dailyGoalXP      Int       @default(20) // daily XP target
  todayXP          Int       @default(0) // resets daily at midnight
  longestStreak    Int       @default(0) // all-time best streak
  totalLessons     Int       @default(0) // total lessons completed
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Mission - stores onboarding wizard results and daily mission config
model Mission {
  id                    String   @id @default(cuid())
  userId                String   @unique
  goal                  String // 'conversation' | 'travel' | 'culture' | 'reading' | 'professional'
  level                 String // 'beginner' | 'intermediate' | 'advanced'
  dailyGoalMinutes      Int      @default(20) // minutes per day
  reminderWindows       String[] @default([]) // e.g., ["09:00-10:00", "19:00-20:00"]
  questSeeds            String[] @default([]) // initial quest IDs to unlock
  onboardingCompletedAt DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([onboardingCompletedAt])
}

// Quest - daily/weekly challenges for learners
model Quest {
  id              String   @id @default(cuid())
  type            String // 'daily' | 'weekly' | 'squad'
  title           String
  description     String   @db.Text
  category        String // 'practice' | 'translation' | 'social' | 'lesson'
  target          Int // target count (e.g., 5 exercises, 20 XP, 3 translations)
  targetUnit      String // 'exercises' | 'xp' | 'translations' | 'minutes'
  xpReward        Int      @default(50)
  currencyReward  Int      @default(10) // gems earned on completion
  difficultyLevel String   @default("medium") // 'easy' | 'medium' | 'hard'
  isActive        Boolean  @default(true)
  startDate       DateTime?
  endDate         DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userProgress UserQuestProgress[]

  @@index([type, isActive, startDate])
  @@index([category])
}

// UserQuestProgress - tracks individual progress on quests
model UserQuestProgress {
  id          String    @id @default(cuid())
  userId      String
  questId     String
  progress    Int       @default(0) // current count toward target
  status      String    @default("active") // 'active' | 'completed' | 'expired'
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  quest Quest @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@unique([userId, questId])
  @@index([userId, status])
  @@index([questId, status])
  @@index([userId, updatedAt])
}

// Badge - achievements and cosmetics
model Badge {
  id               String   @id @default(cuid())
  name             String   @unique
  description      String   @db.Text
  iconUrl          String?
  category         String // 'achievement' | 'cosmetic' | 'seasonal'
  rarityTier       String   @default("common") // 'common' | 'rare' | 'epic' | 'legendary'
  unlockCondition  String   @db.Text // JSON describing unlock criteria
  costGems         Int      @default(0) // 0 for achievements, > 0 for shop purchases
  isAvailableInShop Boolean @default(false)
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  userBadges UserBadge[]

  @@index([category, isActive])
  @@index([isAvailableInShop, isActive])
}

// UserBadge - tracks which badges a user has earned/purchased
model UserBadge {
  id        String    @id @default(cuid())
  userId    String
  badgeId   String
  earnedAt  DateTime?
  purchasedAt DateTime?
  isEquipped Boolean  @default(false) // for display badges
  createdAt DateTime  @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId, isEquipped])
  @@index([badgeId])
  @@index([userId, createdAt])
}

// Currency - tracks gems, coins, or other in-app currency
model Currency {
  id                String   @id @default(cuid())
  userId            String   @unique
  gems              Int      @default(0) // premium currency earned via quests/achievements
  coins             Int      @default(0) // optional secondary currency
  lifetimeGemsEarned Int     @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// CurrencyTransaction - audit log for currency changes
model CurrencyTransaction {
  id          String   @id @default(cuid())
  userId      String
  currencyType String // 'gems' | 'coins'
  amount      Int // positive for earn, negative for spend
  reason      String // 'quest_reward' | 'badge_purchase' | 'admin_grant'
  metadata    String?  @db.Text // JSON with additional context
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([reason])
}

// ReminderSettings - quiet hours + reminder preferences
model ReminderSettings {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  quietHoursEnabled      Boolean  @default(false)
  quietHoursStart        Int      @default(22)
  quietHoursEnd          Int      @default(8)
  streakRemindersEnabled Boolean  @default(true)
  dailyNudgesEnabled     Boolean  @default(true)
  timezone               String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// League - streak-based leaderboards
model League {
  id          String   @id @default(cuid())
  name        String   @unique
  tier        Int // 1 = bronze, 2 = silver, 3 = gold, etc.
  minStreak   Int // minimum streak to qualify
  maxStreak   Int? // maximum streak (null for top tier)
  xpMultiplier Float   @default(1.0)
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members LeagueMembership[]

  @@index([tier])
}

// LeagueMembership - tracks user league placements
model LeagueMembership {
  id        String   @id @default(cuid())
  userId    String
  leagueId  String
  joinedAt  DateTime @default(now())
  rank      Int?     @default(0) // current rank within league
  weeklyXP  Int      @default(0) // XP earned this week (resets weekly)
  promoted  Boolean  @default(false) // promoted to next league
  relegated Boolean  @default(false) // relegated to lower league
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  league League @relation(fields: [leagueId], references: [id], onDelete: Cascade)

  @@unique([userId, leagueId])
  @@index([leagueId, rank])
  @@index([userId])
  @@index([leagueId, weeklyXP])
}

// Notification - inbox messages for reminder intelligence
model Notification {
  id          String    @id @default(cuid())
  userId      String
  type        String // 'streak_warning' | 'quest_invite' | 'admin_note' | 'friend_activity'
  title       String
  body        String    @db.Text
  actionUrl   String?
  isRead      Boolean   @default(false)
  readAt      DateTime?
  scheduledFor DateTime?
  sentAt      DateTime?
  createdAt   DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([type, scheduledFor])
}

// Friendship - social connections between users
model Friendship {
  id          String           @id @default(cuid())
  requesterId String
  addresseeId String
  status      FriendshipStatus @default(PENDING)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  requester User @relation("FriendRequestsSent", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee User @relation("FriendRequestsReceived", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([addresseeId, status])
  @@index([requesterId, status])
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

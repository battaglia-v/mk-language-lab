---
phase: 02-progress-dashboard
plan: 01
type: execute
---

<objective>
Create API layer for user progress tracking tied to UKIM curriculum.

Purpose: Enable the app to know where each user is in the curriculum and update position when lessons complete.
Output: Two API endpoints - GET /api/user/journey-progress and enhanced POST /api/lessons/progress
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-curriculum-backbone/01-04-SUMMARY.md

# Key files from Phase 1
@prisma/schema.prisma (JourneyProgress model lines 183-204)
@app/api/lessons/progress/route.ts (existing progress API)

# Established patterns
- JourneyProgress tracks currentModuleId, currentLessonId per journey
- UKIM journeyIds: ukim-a1, ukim-a2, ukim-b1
- Upsert pattern for idempotent updates

# Decisions
- [01-04]: JourneyIds are ukim-a1, ukim-a2, ukim-b1 for UKIM curriculum
- [01-04]: Database seeded with 40 lessons across 3 modules
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GET /api/user/journey-progress endpoint</name>
  <files>app/api/user/journey-progress/route.ts</files>
  <action>
Create endpoint that returns user's active journey progress with curriculum context:

1. Accept optional `journeyId` query param (defaults to finding active journey)
2. Return:
   - journeyId (ukim-a1, ukim-a2, ukim-b1)
   - currentModule (id, title, orderIndex)
   - currentLesson (id, title, orderIndex, summary)
   - nextLesson (if exists in module or next module)
   - completedLessons count
   - totalLessons count

Include Module and CurriculumLesson relations in query.
If no journey progress exists, return null (new user state).
Use existing auth pattern from app/api/lessons/progress/route.ts.

Avoid: Creating separate queries for each piece - use Prisma includes to get all data in one query.
  </action>
  <verify>curl localhost:3000/api/user/journey-progress returns JSON with journey position or null</verify>
  <done>Endpoint returns journey progress with current/next lesson context, or null for new users</done>
</task>

<task type="auto">
  <name>Task 2: Enhance POST /api/lessons/progress to initialize journey on first completion</name>
  <files>app/api/lessons/progress/route.ts</files>
  <action>
Modify existing lesson progress endpoint to properly track journey position:

1. When status='completed' and lesson is from UKIM module (ukim-a1, ukim-a2, ukim-b1):
   - If no JourneyProgress exists, create one with isActive=true
   - Update currentLessonId to NEXT lesson (not completed one)
   - If lesson was last in module, find first lesson of next module
   - If no next lesson exists, keep currentLessonId as the completed lesson (journey complete state)

2. Fix existing bug: current code updates currentLessonId but doesn't handle module transitions

3. Add logic to mark journey as active (isActive=true) when first lesson completed

Avoid: Changing the response format - keep backward compatible.
  </action>
  <verify>
1. Complete a lesson via POST - journeyProgress should have correct next lesson
2. Check journey is marked isActive=true after first completion
  </verify>
  <done>Lesson completion correctly advances journey position including cross-module transitions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] GET /api/user/journey-progress returns user's curriculum position
- [ ] POST /api/lessons/progress advances journey correctly on completion
- [ ] New users get journey initialized on first lesson complete
- [ ] Module transitions work (last lesson of module -> first of next)
- [ ] No TypeScript errors: npm run type-check passes
</verification>

<success_criteria>
- Both API endpoints working
- Journey position tracked accurately
- Existing lesson progress functionality preserved
- Type-safe implementation
</success_criteria>

<output>
After completion, create `.planning/phases/02-progress-dashboard/02-01-SUMMARY.md`
</output>

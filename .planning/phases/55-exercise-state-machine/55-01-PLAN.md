---
phase: 55-exercise-state-machine
plan: 01
type: execute
---

<objective>
Add SENTENCE_BUILDER step type to LessonRunner with interactive word-arrangement UI.

Purpose: Enable sentence-builder grammar exercises to use native interactive UI instead of falling back to FILL_BLANK (which loses the kinesthetic learning benefit of word arrangement).
Output: Working SentenceBuilder step component integrated into LessonRunner with proper type definitions, validation, and adapter conversion.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-exercise-architecture-research/DISCOVERY.md

# Key source files:
@lib/lesson-runner/types.ts
@lib/lesson-runner/useLessonRunner.ts
@lib/lesson-runner/validation.ts
@lib/lesson-runner/adapters/exercise-adapter.ts
@components/lesson/LessonRunner.tsx
@components/lesson/steps/FillBlank.tsx

# Reference for exercise data model:
@lib/grammar-engine.ts

**From DISCOVERY.md:**
- Sentence-builder exercises currently fall back to FILL_BLANK (loses interactive word-arrangement UI)
- GrammarExerciseCard has sentence-builder fully implemented but unused
- exercise-adapter.ts line 136 has TODO for sentence-builder step type
- SentenceBuilderExercise type has: targetSentenceMk, translationEn, words[], alternativeOrders[][]

**Established patterns:**
- Step components follow pattern in FillBlank.tsx (props: step, onAnswer, feedback, disabled)
- StepAnswer types are discriminated unions in types.ts
- Validation happens in useLessonRunner validateAnswer() switch statement
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SENTENCE_BUILDER step type definitions</name>
  <files>lib/lesson-runner/types.ts</files>
  <action>
    1. Add 'SENTENCE_BUILDER' to StepType union (line ~17)
    2. Create SentenceBuilderStep interface extending BaseStep with:
       - type: 'SENTENCE_BUILDER'
       - words: string[] (shuffled words to arrange)
       - correctOrder: string[] (correct arrangement)
       - alternativeOrders?: string[][] (acceptable alternatives)
       - translationHint?: string (English translation for context)
       - instructions?: string (optional custom instructions)
    3. Add SentenceBuilderStep to Step union type
    4. Add StepAnswer case for SENTENCE_BUILDER:
       { type: 'SENTENCE_BUILDER'; selectedWords: string[]; }
  </action>
  <verify>npm run type-check passes with no errors</verify>
  <done>SentenceBuilderStep and its StepAnswer type exist in types.ts, union types updated</done>
</task>

<task type="auto">
  <name>Task 2: Create SentenceBuilder step component</name>
  <files>components/lesson/steps/SentenceBuilder.tsx</files>
  <action>
    Create SentenceBuilder.tsx following FillBlank.tsx pattern with:

    1. Props: step (SentenceBuilderStep), onAnswer, feedback, disabled
    2. State: selectedWords (string[]) - words user has tapped in order
    3. availableWords derived from step.words minus selectedWords

    UI Layout:
    - Card showing instructions and translation hint
    - "Available Words" section: buttons for words not yet selected (tap to add)
    - "Your Answer" section: shows selected words in order (tap to remove)
    - Visual feedback: correct words green, incorrect red when feedback shown

    Interaction:
    - Tap available word → adds to selectedWords
    - Tap selected word → removes from selectedWords (enables reordering)
    - Auto-call onAnswer when all words selected (mirror FillBlank pattern)

    Styling:
    - Use existing Button, Card patterns from components/ui
    - 48px min-height on buttons for WCAG touch targets
    - Smooth transitions on word movement

    AVOID: Drag-and-drop (mobile compatibility issues). Use tap-to-select per PROJECT.md decision.
  </action>
  <verify>Component renders without TypeScript errors; visually verify word tap/selection works</verify>
  <done>SentenceBuilder.tsx exists with tap-to-select word arrangement UI</done>
</task>

<task type="auto">
  <name>Task 3: Integrate SentenceBuilder into LessonRunner and validation</name>
  <files>
    lib/lesson-runner/validation.ts,
    lib/lesson-runner/useLessonRunner.ts,
    components/lesson/LessonRunner.tsx
  </files>
  <action>
    **validation.ts:**
    1. Add case 'SENTENCE_BUILDER' to validateStep():
       - Check step.words exists and has items
       - Check step.correctOrder exists and has items
       - Check step.words.length === step.correctOrder.length
    2. Add 'SENTENCE_BUILDER' case to getFallbackPrompt() and getDefaultInstructions()

    **useLessonRunner.ts:**
    1. Add case 'SENTENCE_BUILDER' to validateAnswer() (line ~70 area):
       - Check answer.type === 'SENTENCE_BUILDER'
       - Compare answer.selectedWords to step.correctOrder (Unicode-aware)
       - Check alternativeOrders if present
       - Use same feedback pattern as FILL_BLANK

    **LessonRunner.tsx:**
    1. Import SentenceBuilder component
    2. Add case 'SENTENCE_BUILDER' to renderStep() switch (line ~171 area):
       return <SentenceBuilder step={currentStep} {...baseProps} />;
  </action>
  <verify>npm run type-check passes; npm run lint passes</verify>
  <done>LessonRunner handles SENTENCE_BUILDER steps end-to-end</done>
</task>

<task type="auto">
  <name>Task 4: Update exercise adapter to properly convert sentence-builder</name>
  <files>lib/lesson-runner/adapters/exercise-adapter.ts</files>
  <action>
    1. Import SentenceBuilderStep from '../types'
    2. Update case 'sentence-builder' in exerciseToStep() (line ~135):
       - Remove TODO comment and FILL_BLANK fallback
       - Create proper SentenceBuilderStep:
         {
           id: exercise.id,
           type: 'SENTENCE_BUILDER',
           words: sbExercise.words.length ? [...sbExercise.words] : sbExercise.targetSentenceMk.split(' '),
           correctOrder: sbExercise.targetSentenceMk.split(' '),
           alternativeOrders: sbExercise.alternativeOrders,
           translationHint: sbExercise.translationEn,
           instructions: locale === 'en' ? exercise.instructionEn : exercise.instructionMk,
         }
    3. Ensure words array is shuffled (randomize order for challenge)
  </action>
  <verify>npm run type-check passes; adapter produces SENTENCE_BUILDER steps for sentence-builder exercises</verify>
  <done>exercise-adapter.ts converts sentence-builder exercises to SENTENCE_BUILDER steps (no fallback)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run type-check passes with no errors
- [ ] npm run lint passes
- [ ] npm run build succeeds
- [ ] SentenceBuilder component renders in LessonRunner
- [ ] Word selection/deselection works via tap interaction
- [ ] Correct answer validation works (including alternatives)
- [ ] exercise-adapter produces SENTENCE_BUILDER (not FILL_BLANK) for sentence-builder exercises
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript or lint errors
- SENTENCE_BUILDER step type fully integrated into LessonRunner
- sentence-builder grammar exercises use native UI (not FILL_BLANK fallback)
</success_criteria>

<output>
After completion, create `.planning/phases/55-exercise-state-machine/55-01-SUMMARY.md`:

# Phase 55 Plan 01: SENTENCE_BUILDER Step Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `lib/lesson-runner/types.ts` - Added SentenceBuilderStep type
- `components/lesson/steps/SentenceBuilder.tsx` - New component
- `lib/lesson-runner/validation.ts` - Added validation
- `lib/lesson-runner/useLessonRunner.ts` - Added answer validation
- `components/lesson/LessonRunner.tsx` - Added rendering case
- `lib/lesson-runner/adapters/exercise-adapter.ts` - Proper conversion

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 55-02-PLAN.md (ERROR_CORRECTION step)
</output>

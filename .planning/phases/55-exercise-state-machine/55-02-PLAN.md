---
phase: 55-exercise-state-machine
plan: 02
type: execute
---

<objective>
Add ERROR_CORRECTION step type to LessonRunner with click-to-identify-error interaction.

Purpose: Enable error-correction grammar exercises to use native interactive UI instead of falling back to FILL_BLANK (which loses the click-to-identify interaction and forces users to type corrections).
Output: Working ErrorCorrection step component integrated into LessonRunner with proper type definitions, validation, and adapter conversion.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-exercise-architecture-research/DISCOVERY.md
@.planning/phases/55-exercise-state-machine/55-01-SUMMARY.md

# Key source files (updated by 55-01):
@lib/lesson-runner/types.ts
@lib/lesson-runner/useLessonRunner.ts
@lib/lesson-runner/validation.ts
@lib/lesson-runner/adapters/exercise-adapter.ts
@components/lesson/LessonRunner.tsx
@components/lesson/steps/SentenceBuilder.tsx

# Reference for exercise data model:
@lib/grammar-engine.ts

**From DISCOVERY.md:**
- Error-correction exercises currently fall back to FILL_BLANK (loses click-to-identify interaction)
- exercise-adapter.ts line 159 has TODO for error-correction step type
- ErrorCorrectionExercise type has: sentenceWithErrorMk, translationEn, errorWord, correctedWord, errorPosition

**Established patterns:**
- SentenceBuilder.tsx (from 55-01) shows tap-to-select pattern
- Step components use feedback prop to show correct/incorrect state
- Validation in useLessonRunner checks answer type and compares values
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ERROR_CORRECTION step type definitions</name>
  <files>lib/lesson-runner/types.ts</files>
  <action>
    1. Add 'ERROR_CORRECTION' to StepType union
    2. Create ErrorCorrectionStep interface extending BaseStep with:
       - type: 'ERROR_CORRECTION'
       - sentence: string (sentence containing error, words as array for tap targets)
       - words: string[] (sentence split into tappable words)
       - errorIndex: number (index of word with error)
       - correctWord: string (what the error should be replaced with)
       - translationHint?: string (English translation for context)
       - instructions?: string (optional custom instructions)
    3. Add ErrorCorrectionStep to Step union type
    4. Add StepAnswer case for ERROR_CORRECTION:
       { type: 'ERROR_CORRECTION'; selectedIndex: number; correctedWord?: string; }
       (selectedIndex = which word user identified as error; correctedWord = optional correction input)
  </action>
  <verify>npm run type-check passes with no errors</verify>
  <done>ErrorCorrectionStep and its StepAnswer type exist in types.ts, union types updated</done>
</task>

<task type="auto">
  <name>Task 2: Create ErrorCorrection step component</name>
  <files>components/lesson/steps/ErrorCorrection.tsx</files>
  <action>
    Create ErrorCorrection.tsx following established step component patterns:

    1. Props: step (ErrorCorrectionStep), onAnswer, feedback, disabled
    2. State:
       - selectedIndex: number | null (which word user tapped as the error)
       - correctionInput: string (user's typed correction, optional enhancement)

    UI Layout (two-phase interaction):
    **Phase 1 - Identify Error:**
    - Card showing instructions and translation hint
    - Sentence displayed as tappable word buttons
    - Tap a word to identify it as the error
    - After selection, show correction input OR auto-check if we only need identification

    **Phase 2 - (Optional) Provide Correction:**
    - If step requires correction input, show text input for corrected word
    - Can skip this phase and just validate identification for simpler UX

    Visual feedback:
    - Selected word highlighted (primary color)
    - When feedback shown: correct selection green, incorrect red
    - Show the correct word in feedback if wrong

    Interaction flow:
    - Tap word â†’ sets selectedIndex
    - Auto-call onAnswer when word selected (identification-only mode)
    - OR wait for correction input then call onAnswer (full correction mode)

    For MVP: Use identification-only mode (tap correct word = success)

    Styling:
    - 48px min-height on word buttons for WCAG touch targets
    - Words laid out as inline-flex wrap for natural sentence flow
    - Clear visual distinction between regular words and the tapped selection
  </action>
  <verify>Component renders without TypeScript errors; visually verify word tap selection works</verify>
  <done>ErrorCorrection.tsx exists with tap-to-identify-error UI</done>
</task>

<task type="auto">
  <name>Task 3: Integrate ErrorCorrection into LessonRunner and validation</name>
  <files>
    lib/lesson-runner/validation.ts,
    lib/lesson-runner/useLessonRunner.ts,
    components/lesson/LessonRunner.tsx
  </files>
  <action>
    **validation.ts:**
    1. Add case 'ERROR_CORRECTION' to validateStep():
       - Check step.words exists and has items
       - Check step.errorIndex is valid (>= 0, < words.length)
       - Check step.correctWord exists
    2. Add 'ERROR_CORRECTION' case to getFallbackPrompt(): "Find and fix the error"
    3. Add 'ERROR_CORRECTION' case to getDefaultInstructions(): "Tap the word that contains an error."

    **useLessonRunner.ts:**
    1. Add case 'ERROR_CORRECTION' to validateAnswer():
       - Check answer.type === 'ERROR_CORRECTION'
       - Primary validation: answer.selectedIndex === step.errorIndex
       - Optional: if correctedWord provided, also validate it matches step.correctWord (Unicode-aware)
       - Feedback: show which word was the error and the correct form

    **LessonRunner.tsx:**
    1. Import ErrorCorrection component
    2. Add case 'ERROR_CORRECTION' to renderStep() switch:
       return <ErrorCorrection step={currentStep} {...baseProps} />;
  </action>
  <verify>npm run type-check passes; npm run lint passes</verify>
  <done>LessonRunner handles ERROR_CORRECTION steps end-to-end</done>
</task>

<task type="auto">
  <name>Task 4: Update exercise adapter to properly convert error-correction</name>
  <files>lib/lesson-runner/adapters/exercise-adapter.ts</files>
  <action>
    1. Import ErrorCorrectionStep from '../types'
    2. Update case 'error-correction' in exerciseToStep() (line ~157):
       - Remove TODO comment and FILL_BLANK fallback
       - Create proper ErrorCorrectionStep:
         {
           id: exercise.id,
           type: 'ERROR_CORRECTION',
           sentence: ecExercise.sentenceWithErrorMk,
           words: ecExercise.sentenceWithErrorMk.split(' '),
           errorIndex: ecExercise.errorPosition,
           correctWord: ecExercise.correctedWord,
           translationHint: ecExercise.translationEn,
           instructions: locale === 'en' ? exercise.instructionEn : exercise.instructionMk,
         }
    3. Ensure errorPosition from exercise maps correctly to words array index
  </action>
  <verify>npm run type-check passes; adapter produces ERROR_CORRECTION steps for error-correction exercises</verify>
  <done>exercise-adapter.ts converts error-correction exercises to ERROR_CORRECTION steps (no fallback)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run type-check passes with no errors
- [ ] npm run lint passes
- [ ] npm run build succeeds
- [ ] ErrorCorrection component renders in LessonRunner
- [ ] Word tap selection identifies the error correctly
- [ ] Correct/incorrect identification feedback displays properly
- [ ] exercise-adapter produces ERROR_CORRECTION (not FILL_BLANK) for error-correction exercises
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript or lint errors
- ERROR_CORRECTION step type fully integrated into LessonRunner
- error-correction grammar exercises use native UI (not FILL_BLANK fallback)
- Phase 55 complete with both new step types implemented
</success_criteria>

<output>
After completion, create `.planning/phases/55-exercise-state-machine/55-02-SUMMARY.md`:

# Phase 55 Plan 02: ERROR_CORRECTION Step Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcomes]

## Files Created/Modified

- `lib/lesson-runner/types.ts` - Added ErrorCorrectionStep type
- `components/lesson/steps/ErrorCorrection.tsx` - New component
- `lib/lesson-runner/validation.ts` - Added validation
- `lib/lesson-runner/useLessonRunner.ts` - Added answer validation
- `components/lesson/LessonRunner.tsx` - Added rendering case
- `lib/lesson-runner/adapters/exercise-adapter.ts` - Proper conversion

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 55 complete. Ready for Phase 56 (Lesson Flow Progress).
</output>

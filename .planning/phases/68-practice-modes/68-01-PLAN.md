---
phase: 68-practice-modes
plan: 01
type: execute
---

<objective>
Add Grammar Practice mode to the mobile app, mirroring PWA functionality.

Purpose: Enable users to practice grammar exercises organized by A1/A2/B1 tiers with progress tracking and lesson completion.
Output: Grammar Practice screen with tier-organized lesson list, grammar lesson runner, local progress persistence.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-frontmatter.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (practice infrastructure):
@.planning/phases/63-practice-flow/63-02-SUMMARY.md

# PWA reference implementations:
@app/[locale]/practice/grammar/page.tsx
@components/learn/GrammarLessonWrapper.tsx
@data/grammar-lessons.json

# Mobile app patterns:
@apps/mobile/app/(tabs)/practice.tsx
@apps/mobile/components/practice/MultipleChoiceCard.tsx
@apps/mobile/lib/practice.ts

**Tech stack available:** React Native, Expo Router, AsyncStorage
**Established patterns:** Practice card props (onAnswer callback), check-answer-feedback flow, 48px touch targets
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Grammar API endpoint</name>
  <files>app/api/mobile/grammar/route.ts</files>
  <action>
Create GET /api/mobile/grammar endpoint that returns grammar lessons data.

Import grammar-lessons.json and return it with appropriate typing:
- Return full GrammarLesson array with exercises
- Add Cache-Control header (s-maxage=3600) since data is static
- Include meta object with total lesson count and tier breakdown

Follow existing mobile API patterns from app/api/mobile/practice/route.ts.

Type the response as:
```typescript
type GrammarResponse = {
  lessons: GrammarLesson[];
  meta: {
    total: number;
    byTier: { A1: number; A2: number; B1: number };
  };
};
```
  </action>
  <verify>curl http://localhost:3000/api/mobile/grammar returns JSON with lessons array</verify>
  <done>API returns grammar lessons with proper caching headers</done>
</task>

<task type="auto">
  <name>Task 2: Create Grammar Practice screen with tier-organized lesson list</name>
  <files>apps/mobile/app/grammar/index.tsx, apps/mobile/lib/grammar.ts</files>
  <action>
Create grammar practice screen matching PWA's tier-organized layout:

1. **apps/mobile/lib/grammar.ts** - API client and types:
   - fetchGrammarLessons() → GrammarLesson[]
   - GrammarLesson type matching JSON structure
   - AsyncStorage helpers for progress (key: @mklanguage/grammar-progress)
   - Type: LessonProgress = { lessonId, completed, score, completedAt }

2. **apps/mobile/app/grammar/index.tsx** - List screen:
   - Header with back navigation to Practice tab
   - Overall progress bar (completed/total lessons)
   - Three collapsible tier sections (A1 Beginner, A2 Elementary, B1 Intermediate)
   - Each lesson card shows: number/checkmark, title (localized), difficulty badge, curriculum ref badge, exercise count, completion score
   - "Recommended" badge on first incomplete lesson
   - Lesson cards navigate to grammar/[lessonId].tsx
   - Use existing dark theme colors (#06060b background, #f7f8fb text)
   - TouchableOpacity with 48px minimum touch targets

Match visual style from PWA grammar page but adapt for React Native.
  </action>
  <verify>cd apps/mobile && npx tsc --noEmit passes</verify>
  <done>Grammar list screen renders with tier sections and lesson cards</done>
</task>

<task type="auto">
  <name>Task 3: Create Grammar Lesson runner</name>
  <files>apps/mobile/app/grammar/[lessonId].tsx, apps/mobile/components/grammar/GrammarExerciseRunner.tsx</files>
  <action>
Create grammar lesson execution screen:

1. **apps/mobile/components/grammar/GrammarExerciseRunner.tsx**:
   - Accept lesson: GrammarLesson prop
   - Track current exercise index, answers, score
   - Render exercise based on type (multiple-choice, fill-blank, matching)
   - Reuse existing practice card components where possible:
     - multiple-choice → MultipleChoiceCard
     - fill-blank → TypingCard or ClozeCard
   - Show progress header (exercise X of Y)
   - Handle answer submission and feedback
   - On complete: show results (score, XP, retry/continue buttons)
   - Callback onComplete(results) and onExit()

2. **apps/mobile/app/grammar/[lessonId].tsx**:
   - Dynamic route receiving lessonId param
   - Fetch grammar lesson by ID from cached API data
   - Render GrammarExerciseRunner with lesson
   - On complete: save progress to AsyncStorage, show results
   - Results screen with: score percentage, correct/total, XP earned
   - "Continue Learning" → back to grammar list
   - "Retry Lesson" → restart same lesson

Progress storage pattern:
```typescript
const saveProgress = async (lessonId: string, score: number) => {
  const key = '@mklanguage/grammar-progress';
  const existing = JSON.parse(await AsyncStorage.getItem(key) || '[]');
  const updated = [...existing.filter(p => p.lessonId !== lessonId),
    { lessonId, completed: true, score, completedAt: new Date().toISOString() }];
  await AsyncStorage.setItem(key, JSON.stringify(updated));
};
```
  </action>
  <verify>cd apps/mobile && npx tsc --noEmit passes</verify>
  <done>Grammar lesson runner executes exercises and saves progress locally</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes in root
- [ ] `cd apps/mobile && npx tsc --noEmit` passes
- [ ] API endpoint returns grammar lessons JSON
- [ ] Grammar list screen shows A1/A2/B1 tier sections
- [ ] Lesson cards display title, difficulty, exercise count
- [ ] Tapping lesson navigates to lesson runner
- [ ] Lesson runner cycles through exercises
- [ ] Completion saves progress to AsyncStorage
- [ ] Results screen shows score and retry option
</verification>

<success_criteria>
- Grammar Practice mode accessible from Practice tab
- Tier-organized lesson list with progress tracking
- Grammar lesson runner with exercise execution
- Local progress persistence across sessions
- Visual parity with PWA grammar page
</success_criteria>

<output>
After completion, create `.planning/phases/68-practice-modes/68-01-SUMMARY.md` following summary-frontmatter.md template.
</output>

---
phase: 56-lesson-flow-progress
plan: 01
type: execute
---

<objective>
Add lesson resume capability so users can continue interrupted lessons from where they left off.

Purpose: Currently lesson progress saves as percentage only with no step-level state. Users must restart lessons if interrupted. Resume capability improves UX and respects user time investment.
Output: Working resume system - schema extension, API updates, hook state restoration, and Resume/Start Fresh UI prompt.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-exercise-architecture-research/DISCOVERY.md
@.planning/phases/55-exercise-state-machine/55-02-SUMMARY.md

# Key files (from Phase 55):
@lib/lesson-runner/useLessonRunner.ts
@lib/lesson-runner/types.ts
@components/lesson/LessonRunner.tsx
@app/api/lessons/progress/route.ts
@prisma/schema.prisma

# Reference for resume UI pattern:
@components/practice/PracticeSession.tsx (lines 463-492)

**Tech stack available:** Next.js 15, Prisma, TypeScript, shadcn/ui
**Established patterns:**
- Practice session has resume prompt UI (modal with Resume/Start Fresh buttons)
- LessonProgress type already defines `currentStepIndex` and `answers` but not persisted
- API saves percentage-only progress, needs step-level state

**Constraining decisions:**
- Phase 55: New step types (SENTENCE_BUILDER, ERROR_CORRECTION) use discriminated unions
- useLessonRunner hook manages state via useState, not formal state machine

**Issues being addressed:** None from ISSUES.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend schema and API for step-level progress</name>
  <files>prisma/schema.prisma, app/api/lessons/progress/route.ts</files>
  <action>
  1. Add fields to UserLessonProgress model in schema.prisma:
     - `currentStepIndex Int @default(0)` - which step user was on
     - `stepAnswers Json?` - serialized Map of stepId → StepAnswer

  2. Run `npx prisma migrate dev --name add-lesson-step-progress` to create migration.

  3. Update POST handler in route.ts to:
     - Accept `currentStepIndex` and `stepAnswers` in request body
     - Save these fields when provided (backward-compatible with existing calls)

  4. Update GET handler to return full progress including new fields.

  Avoid: Adding validation for stepAnswers JSON shape at API level (trust client, type-check in hook).
  </action>
  <verify>
  - `npx prisma validate` passes
  - `npm run type-check` passes
  - GET /api/lessons/progress?lessonId=xxx returns `currentStepIndex` and `stepAnswers` fields
  </verify>
  <done>Schema migrated, API accepts and returns step-level progress data</done>
</task>

<task type="auto">
  <name>Task 2: Update useLessonRunner with resume state management</name>
  <files>lib/lesson-runner/useLessonRunner.ts, lib/lesson-runner/types.ts</files>
  <action>
  1. Add types to types.ts:
     - `SavedLessonProgress` interface for API response shape
     - Add `onProgressLoaded?: (progress: SavedLessonProgress | null) => void` to hook options

  2. Update useLessonRunner hook:
     - Add `useState` for `savedProgress: SavedLessonProgress | null`
     - Add `useState` for `isLoadingProgress: boolean`
     - On mount (when lessonId provided), fetch GET /api/lessons/progress?lessonId=xxx
     - Call `onProgressLoaded` callback with result

  3. Add `restoreProgress(progress: SavedLessonProgress)` function:
     - Set `currentIndex` to `progress.currentStepIndex`
     - Deserialize and restore `answers` Map from `progress.stepAnswers`
     - Update `startTimeRef` to account for previous time spent

  4. Update auto-save in `submitAnswer` to include:
     - `currentStepIndex: currentIndex`
     - `stepAnswers: Object.fromEntries(answers)` (serialize Map to JSON)

  5. Return from hook:
     - `savedProgress`, `isLoadingProgress`
     - `restoreProgress` function
     - `resetAndStartFresh` function (clears saved progress, resets state)

  Edge case: If `currentStepIndex` exceeds step count (lesson was modified), cap at 0.
  </action>
  <verify>
  - `npm run type-check` passes
  - Hook returns new properties without breaking existing usage
  </verify>
  <done>Hook loads, restores, and persists step-level progress with resume capability</done>
</task>

<task type="auto">
  <name>Task 3: Add resume prompt UI in LessonRunner</name>
  <files>components/lesson/LessonRunner.tsx, messages/en.json, messages/mk.json</files>
  <action>
  1. Add i18n keys to both en.json and mk.json under "lesson" namespace:
     - "resumeTitle": "Continue where you left off?" / "Продолжи од каде што застана?"
     - "resumeDescription": "You were on step {current} of {total}." / "Беше на чекор {current} од {total}."
     - "resumeButton": "Resume" / "Продолжи"
     - "startFreshButton": "Start Fresh" / "Започни одново"

  2. Update LessonRunner component:
     - Import useTranslations
     - Add state: `showResumePrompt: boolean`
     - Get `savedProgress`, `isLoadingProgress`, `restoreProgress`, `resetAndStartFresh` from hook
     - In useEffect: if `savedProgress?.currentStepIndex > 0 && savedProgress?.status === 'in_progress'`, set `showResumePrompt = true`

  3. Add resume modal (before main content, conditional on `showResumePrompt`):
     - Follow Practice session pattern: fixed inset-0, glass-card, z-[60]
     - Display "Continue where you left off?" heading
     - Show step progress: "You were on step X of Y"
     - Two buttons: Resume (calls restoreProgress, hides prompt), Start Fresh (calls resetAndStartFresh, hides prompt)

  4. Add loading state while progress loads (brief spinner or skeleton).

  Avoid: Showing resume prompt for completed lessons (check status !== 'completed').
  </action>
  <verify>
  - Start a lesson, complete 2 steps, exit
  - Reopen lesson → resume prompt appears
  - Click "Resume" → starts at step 3
  - Click "Start Fresh" → starts at step 1
  - `npm run type-check` passes
  </verify>
  <done>Resume prompt UI working, lesson resumes from saved position or starts fresh</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] Schema migration applied successfully
- [ ] Manual test: Start lesson, complete 2 steps, exit, reopen → resume prompt shows
- [ ] Manual test: Click Resume → continues from step 3
- [ ] Manual test: Click Start Fresh → starts from step 1
- [ ] Existing lesson flows still work (autoSave=true/false both tested)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Lessons can be resumed from where user left off
- Resume prompt follows existing UI patterns (Practice session style)
- i18n translations complete (en + mk)
</success_criteria>

<output>
After completion, create `.planning/phases/56-lesson-flow-progress/56-01-SUMMARY.md`:

# Phase 56 Plan 01: Lesson Resume Capability Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `file.ts` - Description

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

[Ready for Phase 57 or next action]
</output>

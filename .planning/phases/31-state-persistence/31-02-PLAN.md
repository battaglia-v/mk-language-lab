---
phase: 31-state-persistence
plan: 02
type: execute
---

<objective>
Integrate session persistence into Quick Practice and add retake capability to results page.

Purpose: Complete the state persistence feature across all practice modes and enable exact session retakes.
Output: Quick Practice session persistence and enhanced results page with retake option.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./31-02-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan context
@.planning/phases/31-state-persistence/31-01-SUMMARY.md

# Key source files
@lib/session-persistence.ts - Session persistence utility (created in 31-01)
@components/learn/quick-practice/useQuickPracticeSession.ts - Quick practice hook
@app/[locale]/practice/results/page.tsx - Results page

**Tech available:**
- Session persistence utility with save/load/clear functions
- Established mkll: localStorage key pattern

**Patterns established:**
- Resume prompt UI pattern from PracticeSession
- Debounced state saves to avoid excessive writes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Quick Practice session type to persistence</name>
  <files>lib/session-persistence.ts</files>
  <action>
Extend the session persistence utility to support Quick Practice sessions:

1. Add `QuickPracticeSessionState` type with fields:
   - `sessionId`: string
   - `category`: string
   - `direction`: 'mkToEn' | 'enToMk'
   - `practiceMode`: string (flashcard/cloze/etc.)
   - `difficulty`: string
   - `currentIndex`: number
   - `totalAttempts`: number
   - `correctCount`: number
   - `hearts`: number
   - `promptSnapshot`: PracticeItem[] (for exact retake)
   - `startedAt`: string
   - `lastUpdatedAt`: string

2. Add functions for Quick Practice:
   - `saveQuickPracticeSession(state: QuickPracticeSessionState): void`
   - `loadQuickPracticeSession(): QuickPracticeSessionState | null`
   - `clearQuickPracticeSession(): void`
   - `hasQuickPracticeSession(): boolean`

3. Use storage key `mkll:quick-practice-session`

4. Import PracticeItem type from quick-practice types (or define minimal inline type)
  </action>
  <verify>npm run type-check passes</verify>
  <done>Quick practice session type and functions added to persistence utility</done>
</task>

<task type="auto">
  <name>Task 2: Integrate persistence into useQuickPracticeSession</name>
  <files>components/learn/quick-practice/useQuickPracticeSession.ts</files>
  <action>
Add session persistence to the Quick Practice hook:

1. Import quick practice persistence functions from `@/lib/session-persistence`

2. Add state for resume flow:
   - `pendingRestore`: boolean
   - `savedSession`: QuickPracticeSessionState | null

3. On hook initialization:
   - Check for saved session via `hasQuickPracticeSession()`
   - If exists and not stale, load it and set pendingRestore=true
   - Expose `pendingRestore` and `savedSession` in return object

4. Add `handleRestoreSession` callback:
   - Restore category, direction, practiceMode, difficulty, currentIndex
   - Restore totalAttempts, correctCount, hearts
   - Use promptSnapshot for exact card order if available
   - Clear pendingRestore

5. Add `handleDeclineRestore` callback:
   - Clear saved session
   - Continue with fresh state

6. On state changes (currentIndex, correctCount, hearts, totalAttempts):
   - Save session state (debounced, ~500ms)
   - Include current promptSource as promptSnapshot

7. On session complete (showCompletionModal or showGameOverModal):
   - Clear saved session

8. On handleReset:
   - Clear saved session

Return new values from hook:
- `pendingRestore`
- `savedSession`
- `handleRestoreSession`
- `handleDeclineRestore`
  </action>
  <verify>npm run type-check passes, hook returns new restore-related values</verify>
  <done>useQuickPracticeSession persists and restores session state</done>
</task>

<task type="auto">
  <name>Task 3: Add retake capability to results page</name>
  <files>app/[locale]/practice/results/page.tsx, lib/session-persistence.ts, messages/en.json, messages/mk.json</files>
  <action>
Enhance the results page with exact retake capability:

1. In lib/session-persistence.ts, add:
   - `RetakeSessionData` type: { deckType, deckSnapshot, difficulty, mode }
   - `saveRetakeData(data: RetakeSessionData): void`
   - `loadRetakeData(): RetakeSessionData | null`
   - `clearRetakeData(): void`
   - Use key `mkll:practice-retake`

2. In PracticeSession.tsx (from 31-01), on endSession:
   - Save retake data with current deck snapshot before navigating to results
   - This preserves the exact deck order for retake

3. In results page (app/[locale]/practice/results/page.tsx):
   - Import retake functions
   - Check for retake data on mount
   - Add new button "Retake Same Questions" between existing buttons
   - When clicked: navigate to session with special `retake=true` param
   - Clear retake data after use or after "Practice Again" (new deck)

4. In PracticeSession.tsx, handle retake param:
   - If URL has `retake=true`, load retake data
   - Use deckSnapshot instead of fetching new deck
   - Clear retake param after loading

5. Add i18n strings to messages/en.json:
   - `drills.retakeSame`: "Retake Same Questions"

6. Add Macedonian translation to messages/mk.json:
   - `drills.retakeSame`: "Повтори ги истите прашања"

Style the retake button with variant="secondary" to differentiate from "Practice Again".
  </action>
  <verify>npm run build succeeds, retake button appears on results page</verify>
  <done>Results page has retake option that replays exact same questions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] Manual test: Quick Practice saves progress when navigating away
- [ ] Manual test: Quick Practice shows restore prompt on return
- [ ] Manual test: Results page shows "Retake Same Questions" button
- [ ] Manual test: Retake loads exact same deck in same order
- [ ] Manual test: "Practice Again" loads fresh shuffled deck
</verification>

<success_criteria>
- Quick Practice session state persists across navigation
- Resume prompt works for Quick Practice
- Results page has retake capability with exact same questions
- Both English and Macedonian translations present
- No TypeScript or lint errors
- Phase 31 complete
</success_criteria>

<output>
After completion, create `.planning/phases/31-state-persistence/31-02-SUMMARY.md`
</output>

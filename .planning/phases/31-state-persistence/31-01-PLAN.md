---
phase: 31-state-persistence
plan: 01
type: execute
---

<objective>
Create session state persistence infrastructure for deck-based practice sessions.

Purpose: Allow users to resume interrupted practice sessions instead of losing progress when navigating away.
Output: Session persistence utility and PracticeSession integration with resume prompt.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./31-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/29-lesson-enhancements/29-02-SUMMARY.md
@.planning/phases/30-vocabulary-display/30-02-SUMMARY.md

# Key source files
@lib/spaced-repetition.ts - Established localStorage patterns with mkll: prefix
@components/practice/PracticeSession.tsx - Target component for persistence
@app/[locale]/practice/session/page.tsx - Practice session page

**Established patterns:**
- localStorage keys use `mkll:` prefix (e.g., `mkll:spaced-repetition`)
- sessionStorage for temporary data (prompt caching)
- Type-safe read/write utilities with error handling

**Constraining decisions:**
- Session-only sort preference in Phase 29 - but full session state warrants persistence
- Grammar progress already persists to localStorage (`grammar-progress` key)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session persistence utility</name>
  <files>lib/session-persistence.ts</files>
  <action>
Create a new utility module for practice session state persistence:

1. Define `PracticeSessionState` type with fields:
   - `sessionId`: string (unique ID for this session)
   - `deckType`: string (deck identifier)
   - `customDeckId`: string | null
   - `difficulty`: string
   - `mode`: string (typing/multiple-choice)
   - `deckSnapshot`: Flashcard[] (preserve exact deck order for retake)
   - `currentIndex`: number
   - `reviewedCount`: number
   - `correctAnswers`: number
   - `maxStreak`: number
   - `startedAt`: string (ISO timestamp)
   - `lastUpdatedAt`: string (ISO timestamp)

2. Implement functions:
   - `savePracticeSession(state: PracticeSessionState): void` - save to localStorage
   - `loadPracticeSession(): PracticeSessionState | null` - load from localStorage
   - `clearPracticeSession(): void` - clear saved session
   - `hasSavedSession(): boolean` - check if session exists
   - `isSessionStale(maxAgeHours: number): boolean` - check if session is too old (default 24h)

3. Use storage key `mkll:practice-session` following established pattern
4. Include error handling with console.warn for parse failures
5. Add JSDoc comments explaining the purpose
  </action>
  <verify>File exists at lib/session-persistence.ts with exported functions</verify>
  <done>Session persistence utility created with save/load/clear/check functions</done>
</task>

<task type="auto">
  <name>Task 2: Integrate persistence into PracticeSession</name>
  <files>components/practice/PracticeSession.tsx</files>
  <action>
Integrate session persistence into the PracticeSession component:

1. Import session persistence functions from `@/lib/session-persistence`

2. On component mount (in useEffect after deck loads):
   - Check if there's a saved session matching current deckType
   - If match found and not stale, set `pendingRestore` state to true
   - Show resume prompt (handled in Task 3)

3. Add `handleRestore` callback:
   - Load saved session state
   - Set index, reviewedCount, correctAnswers, maxStreak from saved state
   - Use deckSnapshot if available for exact card order
   - Clear the pendingRestore state

4. Add `handleStartFresh` callback:
   - Clear saved session
   - Reset all counters to initial state

5. On state changes (index, correctAnswers, etc.):
   - Save session state via debounced save (avoid excessive writes)
   - Only save if session is active (not on results page)

6. On session end (endSession function):
   - Clear saved session state

7. Add state variables:
   - `pendingRestore`: boolean (show resume prompt)
   - `savedSession`: PracticeSessionState | null

Do NOT add any new UI elements in this task - just the state management logic.
  </action>
  <verify>npm run type-check passes, no new TypeScript errors</verify>
  <done>PracticeSession saves/loads session state, pendingRestore triggers resume flow</done>
</task>

<task type="auto">
  <name>Task 3: Add resume prompt UI and i18n</name>
  <files>components/practice/PracticeSession.tsx, messages/en.json, messages/mk.json</files>
  <action>
Add the resume prompt UI when a saved session is detected:

1. In PracticeSession, when `pendingRestore` is true and `savedSession` exists:
   - Show a modal/overlay with:
     - Title: "Resume Session?"
     - Description showing progress: "You have a session in progress with X/Y cards completed"
     - Two buttons: "Resume" (primary) and "Start Fresh" (outline)
   - Use existing Card/Button components for consistency

2. Add i18n strings to messages/en.json under practiceHub:
   - `resumeSession.title`: "Resume Session?"
   - `resumeSession.description`: "You have a session in progress with {reviewed} cards reviewed."
   - `resumeSession.resume`: "Resume"
   - `resumeSession.startFresh`: "Start Fresh"

3. Add corresponding Macedonian translations to messages/mk.json:
   - `resumeSession.title`: "Продолжи сесија?"
   - `resumeSession.description`: "Имаш сесија во тек со {reviewed} прегледани картички."
   - `resumeSession.resume`: "Продолжи"
   - `resumeSession.startFresh`: "Започни одново"

4. Style the modal to match existing app patterns (glass-card, rounded-xl, etc.)
  </action>
  <verify>npm run build succeeds, resume prompt appears when saved session exists</verify>
  <done>Resume prompt UI displays with i18n support, allows resuming or starting fresh</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] Manual test: Start practice, navigate away, return - see resume prompt
- [ ] Manual test: Click "Resume" restores progress
- [ ] Manual test: Click "Start Fresh" begins new session
- [ ] Manual test: Complete session - saved state is cleared
</verification>

<success_criteria>
- lib/session-persistence.ts exists with type-safe utilities
- PracticeSession component persists state to localStorage
- Resume prompt appears when returning with saved session
- Both English and Macedonian translations present
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-state-persistence/31-01-SUMMARY.md`
</output>

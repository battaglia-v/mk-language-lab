---
phase: 64-reader-flow
plan: 02
type: execute
---

<objective>
Story viewer with tap-to-translate functionality.

Purpose: Enable reading stories with instant word translation on tap.
Output: Story viewer screen with tappable text and translation popup.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/64-reader-flow/64-01-SUMMARY.md

# Web tap-to-translate patterns:
@components/reader/TappableTextV2.tsx
@components/reader/WordBottomSheet.tsx

# Mobile reader lib:
@apps/mobile/lib/reader.ts

# Mobile bottom sheet patterns (if exists):
Check for existing bottom sheet or modal patterns in mobile app.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create story viewer screen</name>
  <files>apps/mobile/app/reader/[id].tsx</files>
  <action>
Create story viewer screen at dynamic route `/reader/[id]`.

UI structure:
- Header: Back button, story title, difficulty badge
- ScrollView with story content
- Each text_block_mk rendered as styled paragraph

Fetch story detail using fetchStoryDetail(id) on mount.
Show loading state while fetching.
Show error state if story not found.

Text styling:
- Font size 18-20 for readability
- Line height 1.6-1.8
- Dark background (#06060b), light text (#f7f8fb)
- Paragraphs separated by margin

Navigation: Use expo-router useLocalSearchParams to get id.
  </action>
  <verify>Story content renders correctly</verify>
  <done>Story viewer displays full story text</done>
</task>

<task type="auto">
  <name>Task 2: Implement tap-to-translate</name>
  <files>apps/mobile/components/reader/TappableText.tsx, apps/mobile/components/reader/WordPopup.tsx</files>
  <action>
Create tappable text component and word translation popup.

TappableText component:
- Split text into words (preserve punctuation)
- Each word wrapped in Pressable
- On press: look up translation, show popup

Translation lookup:
1. Check story vocabulary array (exact match)
2. Fallback to loading state + API call to /api/translate

WordPopup component (Modal or custom popup):
- Word in Macedonian (large, bold)
- Translation in English
- Part of speech badge (if available)
- "Save to Glossary" button (placeholder for 64-03)
- Dismiss on tap outside or X button

Popup positioning: Center of screen (simpler than web bottom sheet).
Use React Native Modal for overlay.

Word matching: Normalize (lowercase, remove punctuation) before lookup.
  </action>
  <verify>Tapping word shows translation popup</verify>
  <done>Tap-to-translate works with vocabulary lookup</done>
</task>

<task type="auto">
  <name>Task 3: Add translate API fallback</name>
  <files>apps/mobile/lib/reader.ts</files>
  <action>
Add translation function for words not in vocabulary.

```typescript
export async function translateWord(word: string): Promise<string | null>;
```

Call existing /api/translate endpoint:
```
POST /api/translate
{ text: word, sourceLang: 'mk', targetLang: 'en' }
```

Response: { translatedText: string }

Handle errors gracefully (return null on failure).
Cache translations in-memory during session (simple Map).

Update TappableText to use this fallback when vocabulary lookup fails.
  </action>
  <verify>Unknown words get translated via API</verify>
  <done>Fallback translation works for words not in vocabulary</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes in apps/mobile
- [ ] Story viewer renders full story
- [ ] Tapping word shows translation popup
- [ ] Vocabulary words translate instantly
- [ ] Unknown words translate via API fallback
</verification>

<success_criteria>

- Story viewer screen displays full story content
- Tappable text enables word-by-word translation
- Translation popup shows word, translation, POS
- API fallback handles words not in vocabulary
</success_criteria>

<output>
After completion, create `.planning/phases/64-reader-flow/64-02-SUMMARY.md`
</output>

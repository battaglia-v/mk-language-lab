---
phase: 64-reader-flow
plan: 03
type: execute
---

<objective>
Reading progress tracking and save-to-glossary functionality.

Purpose: Track reading progress and allow saving words for later review.
Output: Progress persistence, Continue Reading card, save word functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/64-reader-flow/64-02-SUMMARY.md

# Web reading progress patterns:
@lib/reading-progress.ts
@lib/favorites.ts

# Mobile session persistence patterns:
@apps/mobile/lib/session-persistence.ts

# Story viewer:
@apps/mobile/app/reader/[id].tsx
@apps/mobile/components/reader/WordPopup.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reading progress persistence</name>
  <files>apps/mobile/lib/reading-progress.ts</files>
  <action>
Create reading progress storage using AsyncStorage.

```typescript
export type ReadingProgress = {
  storyId: string;
  scrollPosition: number; // 0-1 percentage
  completed: boolean;
  lastReadAt: number; // epoch ms
};

export async function saveProgress(progress: ReadingProgress): Promise<void>;
export async function loadProgress(storyId: string): Promise<ReadingProgress | null>;
export async function loadAllProgress(): Promise<ReadingProgress[]>;
export async function markComplete(storyId: string): Promise<void>;
```

Storage key: `@mklanguage/reading-progress`
Store as JSON object keyed by storyId.

Auto-save on scroll (debounced 1000ms).
Mark complete when scrolled to bottom (scrollPosition > 0.95).
  </action>
  <verify>Progress saves and loads correctly</verify>
  <done>Reading progress persists across app restarts</done>
</task>

<task type="auto">
  <name>Task 2: Integrate progress into story viewer</name>
  <files>apps/mobile/app/reader/[id].tsx</files>
  <action>
Add progress tracking to story viewer.

On mount:
- Load existing progress for storyId
- Scroll to saved position

On scroll:
- Debounced save of scroll position
- Auto-mark complete at bottom

Add "Mark Complete" button at end of story.
Show completion badge in header when story is complete.

Use onScroll event from ScrollView.
Calculate scroll percentage: contentOffset.y / (contentSize.height - layoutHeight).
  </action>
  <verify>Scroll position persists between visits</verify>
  <done>Story viewer tracks and restores reading progress</done>
</task>

<task type="auto">
  <name>Task 3: Add save-to-glossary functionality</name>
  <files>apps/mobile/lib/glossary.ts, apps/mobile/components/reader/WordPopup.tsx</files>
  <action>
Create glossary storage and connect to word popup.

glossary.ts:
```typescript
export type SavedWord = {
  id: string;
  mk: string;
  en: string;
  pos?: string;
  savedAt: number;
  source: string; // story id
};

export async function saveWord(word: SavedWord): Promise<void>;
export async function getSavedWords(): Promise<SavedWord[]>;
export async function removeWord(id: string): Promise<void>;
export async function isWordSaved(mk: string): Promise<boolean>;
```

Storage key: `@mklanguage/glossary`

Update WordPopup:
- Check if word already saved on open
- "Save to Glossary" button saves word
- Show "Saved!" feedback with check icon
- Disable button if already saved

Word id: `word-${mk.toLowerCase()}`
  </action>
  <verify>Words can be saved from popup</verify>
  <done>Save-to-glossary works from translation popup</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes in apps/mobile
- [ ] Reading progress saves on scroll
- [ ] Story resumes from last position
- [ ] Save-to-glossary works from word popup
- [ ] Completed stories show badge
</verification>

<success_criteria>

- Reading progress persists across sessions
- Story viewer restores scroll position
- Words can be saved to glossary
- Completion tracked and displayed
- Phase 64 Reader Flow complete
</success_criteria>

<output>
After completion, create `.planning/phases/64-reader-flow/64-03-SUMMARY.md`
</output>

---
phase: 38-reader-vocabulary-save
plan: 01
type: execute
---

<objective>
Unify reader glossary with the favorites system so words saved via tap-to-translate appear in the glossary drawer.

Purpose: Enable saving words directly to glossary while reading stories - completing the tap-to-translate → save → review flow.
Output: Working glossary that shows all reader-saved words from the favorites system, with add/remove functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./38-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context
@.planning/phases/37-tap-to-translate/37-02-SUMMARY.md

# Key source files
@components/reader/ReaderV2Layout.tsx
@components/reader/GlossaryDrawer.tsx
@components/reader/TappableText.tsx
@lib/favorites.ts

**Tech stack available:** Next.js 16, React, TypeScript, Tailwind
**Established patterns:** favorites.ts system with category filtering, localStorage persistence
**Constraining decisions:**
- Phase 37: TappableText saves with `category: 'reader'` to favorites
- v1.4: Favorites system established with category support

**The Problem:**
TappableText saves words to `lib/favorites.ts` (key: `mkll:favorites`) with `category: 'reader'`.
ReaderV2Layout uses a separate `reader-glossary` localStorage key.
These systems are disconnected - words saved via tap don't show in glossary drawer.

**The Fix:**
Unify on the favorites system. ReaderV2Layout and GlossaryDrawer should read/write from favorites filtered by `category='reader'`.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unify ReaderV2Layout glossary state with favorites system</name>
  <files>components/reader/ReaderV2Layout.tsx</files>
  <action>
Update ReaderV2Layout to use the favorites system instead of separate localStorage:

1. Import favorites functions: `import { readFavorites, addFavorite, removeFavorite } from '@/lib/favorites';`

2. Replace the `useState<SavedWord[]>` initialization:
   - Instead of reading from `reader-glossary` localStorage, call `readFavorites()` and filter by `category === 'reader'`
   - Map FavoriteItem to SavedWord format for compatibility

3. Update `addToGlossary` function:
   - Call `addFavorite()` with category='reader' instead of manual localStorage
   - Re-read favorites to update state (or optimistically update)

4. Update `removeFromGlossary` function:
   - Call `removeFavorite(wordId)` instead of manual localStorage
   - Re-read favorites to update state

5. Remove the separate `reader-glossary` localStorage operations entirely

6. Update SavedWord type to include all fields from FavoriteItem that GlossaryDrawer needs (original→macedonian, translation→english mapping)

AVOID: Don't break existing TappableText integration - it already uses toggleFavorite() with category='reader'. The goal is to make GlossaryDrawer read from the same source.
  </action>
  <verify>
Run `npm run type-check` to ensure no TypeScript errors.
Run `npm run lint` to check for issues.
  </verify>
  <done>
- ReaderV2Layout reads glossary from favorites system filtered by category='reader'
- Add/remove operations use favorites API
- No more `reader-glossary` localStorage key usage
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update GlossaryDrawer for favorites-compatible data</name>
  <files>components/reader/GlossaryDrawer.tsx, components/reader/ReaderV2Layout.tsx</files>
  <action>
Update GlossaryDrawer to work with the favorites-based data structure:

1. Update SavedWord interface (in ReaderV2Layout or shared location):
   - Ensure it maps cleanly from FavoriteItem
   - `id: string` (same)
   - `original: string` (from FavoriteItem.macedonian)
   - `translation: string` (from FavoriteItem.english)
   - `partOfSpeech?: string` (if stored)
   - `savedAt: Date` (from FavoriteItem.favoritedAt - parse ISO string)

2. In GlossaryDrawer, verify the word list renders correctly:
   - Word cards should display original (Macedonian) and translation (English)
   - Audio playback uses original (Macedonian) text
   - Remove button calls onRemoveWord with correct id

3. Verify mini flashcard review mode works:
   - Cards display original and translation
   - Navigation between cards functions

4. Update the glossary badge count in footer to reflect actual favorites count
   (it should update automatically since it reads from savedWords state)

AVOID: Don't change GlossaryDrawer's prop interface unless necessary - keep it compatible with existing usage.
  </action>
  <verify>
1. Run `npm run dev`, navigate to a graded reader story
2. Tap a word to see translation popup
3. Click "Save to Glossary" button
4. Open Glossary drawer from footer
5. Verify saved word appears in list
6. Test "Review Now" flashcard mode
7. Test remove word functionality
8. Refresh page - saved words should persist
  </verify>
  <done>
- Words saved via tap appear in glossary drawer
- Badge count updates correctly
- Review mode works with saved words
- Remove functionality works
- Data persists across page refreshes
- No visual regressions in drawer UI
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] `npm run build` succeeds
- [ ] Tap word → Save → Opens glossary → Word visible
- [ ] Review mode functions correctly
- [ ] Remove word from glossary works
- [ ] Data persists across refresh
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Words saved via tap-to-translate appear in glossary drawer
- Unified storage (no more duplicate localStorage keys)
- Mini flashcard review works with saved words
</success_criteria>

<output>
After completion, create `.planning/phases/38-reader-vocabulary-save/38-01-SUMMARY.md` with:

# Phase 38 Plan 01: Reader Vocabulary Save Summary

**[Substantive one-liner describing what shipped]**

## Performance
- Duration: X min
- Tasks: 2

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Phase Readiness
Ready for Phase 39: Reading Progress
</output>

---
phase: 03-lesson-practice-integrity
plan: 02
type: execute
---

<objective>
Create API endpoint and practice deck support for completed-lesson vocabulary filtering.

Purpose: Build infrastructure for "completed content only" practice mode that pulls from lessons user has finished.
Output: GET /api/practice/lesson-vocab endpoint and updated practice decks hook.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lesson-practice-integrity/DISCOVERY.md

# Key source files:
@app/api/practice/prompts/route.ts
@app/api/user/journey-progress/route.ts
@components/practice/usePracticeDecks.ts
@lib/learn/curriculum-path.ts
@prisma/schema.prisma

# Models involved:
# - UserLessonProgress (tracks completed lessons)
# - VocabularyItem (lesson-linked vocab - currently empty)
# - Exercise (lesson-linked exercises - currently empty)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GET /api/practice/lesson-vocab endpoint</name>
  <files>app/api/practice/lesson-vocab/route.ts</files>
  <action>
Create new API endpoint that returns vocabulary from user's completed lessons:

```typescript
// GET /api/practice/lesson-vocab
// Query params: ?lessonId=xxx (optional, specific lesson) or returns all completed

1. Require authentication (getServerSession)
2. Get user's completed lesson IDs from UserLessonProgress
3. Query VocabularyItem where lessonId IN completedLessonIds
4. Return as Flashcard-compatible format:
   {
     id: string,
     macedonian: string,
     english: string,
     lessonId: string,
     lessonTitle: string, // Include for context
     category: string | null
   }[]
5. If no completed lessons or no vocab, return empty array (not error)
```

Follow existing patterns from `/api/practice/prompts/route.ts` for response format.
Include lesson context (title, module) in response for UI display.

Note: This will return empty until VocabularyItem is seeded, which is expected.
  </action>
  <verify>curl -s http://localhost:3000/api/practice/lesson-vocab 2>/dev/null | head -20 || echo "Server not running - verify file exists"; ls app/api/practice/lesson-vocab/route.ts</verify>
  <done>Endpoint exists and returns array (empty or with data depending on seeding)</done>
</task>

<task type="auto">
  <name>Task 2: Add lesson-vocab deck type to practice decks hook</name>
  <files>components/practice/usePracticeDecks.ts, components/practice/types.ts</files>
  <action>
Update practice deck infrastructure to support lesson-based filtering:

1. In types.ts, add to DeckType union:
   - 'lesson-review' - vocabulary from completed lessons

2. In usePracticeDecks.ts:
   - Add state for lessonVocabDeck
   - Add loadLessonVocab() function that fetches from /api/practice/lesson-vocab
   - Add getLessonVocabDeck() to getDeck switch statement
   - Include lesson context in returned flashcards

3. The deck will show "No vocabulary yet" message when empty (handled in UI, not here)

Ensure the new deck type follows same Flashcard interface as other decks.
Don't modify existing deck types - this is additive.
  </action>
  <verify>grep -n "lesson-review" components/practice/types.ts && grep -n "lessonVocab" components/practice/usePracticeDecks.ts</verify>
  <done>lesson-review deck type added to types and usePracticeDecks supports it</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] API endpoint file exists at app/api/practice/lesson-vocab/route.ts
- [ ] DeckType includes 'lesson-review'
- [ ] usePracticeDecks has lessonVocab functions
</verification>

<success_criteria>

- API endpoint created and type-safe
- Practice decks hook supports lesson-vocab deck type
- No TypeScript errors
- Infrastructure ready for when vocab is seeded
</success_criteria>

<output>
After completion, create `.planning/phases/03-lesson-practice-integrity/03-02-SUMMARY.md`
</output>

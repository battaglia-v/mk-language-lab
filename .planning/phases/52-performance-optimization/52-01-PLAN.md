---
phase: 52-performance-optimization
plan: 01
type: execute
---

<objective>
Implement caching and prefetching optimizations for faster page loads and smoother navigation.

Purpose: Reduce server load and perceived latency by caching static curriculum data and prefetching common navigation targets.
Output: Cached API responses, prefetched routes, measurably faster navigation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant source files
@next.config.ts
@lib/lazy-components.tsx
@packages/api-client/src/profile.ts (staleTime pattern reference)

# Current state
- 40 curriculum lessons loaded dynamically on every request
- No Cache-Control headers on curriculum-related APIs
- Limited prefetching (only `prefetch={true}` on some Links)
- Framer Motion already chunked via webpack config
- Existing staleTime patterns in API client (5 min for profile, discover, news; 1 min for practice)

# Prior summaries (v1.8 milestone)
@.planning/phases/51-content-quality-audit/51-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add curriculum data caching to lesson API</name>
  <files>app/[locale]/lesson/[lessonId]/page.tsx, app/api/lessons/[lessonId]/route.ts (create if needed)</files>
  <action>
Add caching to curriculum lesson data since it's static between deployments:

1. In `app/[locale]/lesson/[lessonId]/page.tsx`:
   - Add `export const revalidate = 3600;` (1 hour) - curriculum data rarely changes
   - Use `unstable_cache` from 'next/cache' to wrap the Prisma lesson query with tag 'curriculum'
   - Keep user progress fetch uncached (personalized data)

2. Pattern for `unstable_cache`:
```typescript
import { unstable_cache } from 'next/cache';

const getCachedLesson = unstable_cache(
  async (lessonId: string) => {
    return prisma.curriculumLesson.findUnique({...});
  },
  ['curriculum-lesson'],
  { revalidate: 3600, tags: ['curriculum'] }
);
```

Do NOT cache user progress - that must stay dynamic.
  </action>
  <verify>
1. Build passes: `npm run build`
2. Type check passes: `npm run type-check`
3. Dev server starts without errors
  </verify>
  <done>Lesson page has revalidate export and curriculum data is cached via unstable_cache</done>
</task>

<task type="auto">
  <name>Task 2: Add Cache-Control headers to curriculum APIs</name>
  <files>app/api/practice/lesson-vocab/route.ts, app/api/user/vocabulary/route.ts</files>
  <action>
Add Cache-Control headers to read-heavy APIs that serve semi-static data:

1. `app/api/practice/lesson-vocab/route.ts` - lesson vocabulary is curriculum data
   - Add `export const revalidate = 300;` (5 min)
   - Add Cache-Control header in GET response:
   ```typescript
   return NextResponse.json(data, {
     headers: { 'Cache-Control': 'public, s-maxage=300, stale-while-revalidate=600' }
   });
   ```

2. `app/api/user/vocabulary/route.ts` - GET endpoint for user's saved vocabulary
   - This is personalized so keep it dynamic but add short client cache:
   ```typescript
   return NextResponse.json(data, {
     headers: { 'Cache-Control': 'private, max-age=30, stale-while-revalidate=60' }
   });
   ```

Use `s-maxage` for CDN caching on public data, `max-age` for private data.
  </action>
  <verify>
1. Build passes: `npm run build`
2. Verify headers with curl: `curl -I localhost:3000/api/practice/lesson-vocab?lessonId=test`
  </verify>
  <done>Cache-Control headers added to vocabulary APIs with appropriate TTLs</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation prefetching for common routes</name>
  <files>components/shell/MobileTabNav.tsx, components/shell/SidebarNav.tsx, components/learn/LessonPathNode.tsx</files>
  <action>
Ensure route prefetching is enabled for common navigation patterns:

1. `components/shell/MobileTabNav.tsx` and `components/shell/SidebarNav.tsx`:
   - Verify all navigation Links have `prefetch={true}` (Next.js default)
   - Add hover-based preloading for heavy routes using router.prefetch():
   ```typescript
   const router = useRouter();
   // On hover over Practice link
   onMouseEnter={() => router.prefetch('/practice')}
   ```

2. `components/learn/LessonPathNode.tsx`:
   - The lesson link already has `prefetch={true}` from git history
   - Add preloading of next lesson on current lesson page load:
   ```typescript
   // Preload next lesson link on mount if nextLesson exists
   useEffect(() => {
     if (nextLesson?.id) {
       router.prefetch(`/lesson/${nextLesson.id}`);
     }
   }, [nextLesson?.id, router]);
   ```

Focus on Learn → Practice → Reader navigation cycle (the core user journey).
  </action>
  <verify>
1. Type check passes: `npm run type-check`
2. Dev server: Navigate through Learn → Practice → Reader, observe network tab for prefetch requests
  </verify>
  <done>Navigation components prefetch common routes on hover/mount</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run type-check` passes
- [ ] Lesson pages load from cache on subsequent visits (check response headers)
- [ ] Navigation between main sections feels snappier
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Curriculum data cached for 1 hour
- API endpoints have appropriate Cache-Control headers
- Navigation prefetching enabled for core user journey
</success_criteria>

<output>
After completion, create `.planning/phases/52-performance-optimization/52-01-SUMMARY.md` following the summary template.
</output>

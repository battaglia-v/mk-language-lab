---
phase: 18-ci-pipeline-improvements
plan: 01
type: execute
---

<objective>
Optimize CI pipeline build times with caching improvements identified in Phase 17 audit.

Purpose: Reduce CI pipeline execution time by ~30% through strategic caching of Next.js build cache and Playwright browsers.
Output: Updated ci.yml with caching optimizations, verified faster build times.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-ci-pipeline-audit/CI-AUDIT.md
@.planning/phases/17-ci-pipeline-audit/17-01-SUMMARY.md

# Key context from Phase 17 audit:
- Current critical path: build → e2e → ci-success (~10-12 min)
- e2e.yml already has Next.js cache (ci.yml does not)
- Playwright browser install adds ~1 min to e2e job
- All v1.2 CI gates already exist - this is optimization only

# Source files:
@.github/workflows/ci.yml
@.github/workflows/e2e.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Next.js build cache to ci.yml</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Add Next.js build cache to the `build` job in ci.yml. Copy the cache configuration from e2e.yml (lines 29-36):

```yaml
- name: Cache Next.js build
  uses: actions/cache@v4
  with:
    path: |
      .next/cache
    key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
    restore-keys: |
      ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
```

Insert this step AFTER "Install dependencies" and BEFORE "Generate Prisma Client" in the build job. This ensures node_modules exists before cache restore, and cache is available for the build step.

The cache key includes both package-lock.json hash (dependencies) and source file hashes (code changes), with fallback to just package-lock for partial cache hits.
  </action>
  <verify>
Run `cat .github/workflows/ci.yml | grep -A 10 "Cache Next.js"` to confirm cache step exists in build job.
Verify step order: checkout → setup-node → install → **cache** → prisma → build
  </verify>
  <done>ci.yml build job has Next.js cache step in correct position</done>
</task>

<task type="auto">
  <name>Task 2: Add Playwright browser cache to e2e job</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Add Playwright browser cache to the `e2e` job in ci.yml. Insert BEFORE the "Install Playwright browsers" step:

```yaml
- name: Cache Playwright browsers
  uses: actions/cache@v4
  id: playwright-cache
  with:
    path: ~/.cache/ms-playwright
    key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
```

Then modify the "Install Playwright browsers" step to skip install if cache hit:

```yaml
- name: Install Playwright browsers
  if: steps.playwright-cache.outputs.cache-hit != 'true'
  run: npx playwright install --with-deps chromium
```

This saves ~1 minute per CI run when Playwright version hasn't changed. The cache key uses package-lock.json hash because Playwright version is pinned there.

**Important:** Keep `--with-deps` flag to install system dependencies on cache miss.
  </action>
  <verify>
Run `cat .github/workflows/ci.yml | grep -A 8 "Cache Playwright"` to confirm cache step exists.
Run `cat .github/workflows/ci.yml | grep -A 3 "Install Playwright"` to confirm conditional execution.
  </verify>
  <done>ci.yml e2e job has Playwright cache with conditional install step</done>
</task>

<task type="auto">
  <name>Task 3: Verify and commit optimizations</name>
  <files>.github/workflows/ci.yml, .planning/STATE.md, .planning/ROADMAP.md</files>
  <action>
1. Validate the modified ci.yml is valid YAML:
   ```bash
   npx yaml-lint .github/workflows/ci.yml || python3 -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"
   ```
   (Use python fallback if yaml-lint not available)

2. Run a quick syntax check by checking GitHub Actions workflow schema patterns (ensure jobs, steps, uses are correct).

3. Update .planning/STATE.md:
   - Update "Current Position" to show Phase 18 complete
   - Update progress percentage (~10%)
   - Update "Next step" to Phase 19 (Cloudflare Research)
   - Check off "CI optimizations applied" in v1.2 success criteria

4. Update .planning/ROADMAP.md:
   - Mark Phase 18 plan 01 as complete
   - Update Phase 18 status to Complete in progress table

5. Commit changes with message following project conventions.
  </action>
  <verify>
YAML validation passes (no parse errors).
STATE.md shows Phase 18 complete, Phase 19 as next step.
ROADMAP.md shows Phase 18 complete.
Git shows clean commit with ci.yml and planning docs.
  </verify>
  <done>
ci.yml optimizations committed, planning docs updated, ready for Phase 19
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ci.yml build job has Next.js cache step
- [ ] ci.yml e2e job has Playwright cache step with conditional install
- [ ] YAML syntax is valid (no parse errors)
- [ ] STATE.md updated with Phase 18 complete
- [ ] ROADMAP.md updated with Phase 18 complete
- [ ] Changes committed to git
</verification>

<success_criteria>

- All 3 tasks completed
- ci.yml has both caching optimizations
- YAML is syntactically valid
- Planning docs reflect Phase 18 complete
- Commit created with descriptive message
</success_criteria>

<output>
After completion, create `.planning/phases/18-ci-pipeline-improvements/18-01-SUMMARY.md`:

# Phase 18 Plan 01: CI Pipeline Improvements Summary

**[Substantive one-liner about caching optimizations added]**

## Performance

- **Duration:** X min
- **Tasks:** 3

## Accomplishments

- Added Next.js build cache to ci.yml build job
- Added Playwright browser cache to e2e job
- Expected CI time reduction: ~2-3 minutes per run

## Files Modified

- `.github/workflows/ci.yml` - Added caching steps
- `.planning/STATE.md` - Updated position
- `.planning/ROADMAP.md` - Marked Phase 18 complete

## Decisions Made

[Any decisions, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Ready for Phase 19: Cloudflare Research & PoC
- CI optimizations will be validated by next PR run
</output>

---
phase: 39-reading-progress
plan: 01
type: execute
---

<objective>
Track story completion, reading position, and time spent per story.

Purpose: Enable users to resume reading where they left off and see their reading progress across all stories.
Output: Reading progress persistence via localStorage with visual indicators in the library.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (reader subsystem)
@.planning/phases/37-tap-to-translate/37-02-SUMMARY.md
@.planning/phases/38-reader-vocabulary-save/38-01-SUMMARY.md

# Key source files
@lib/favorites.ts
@components/reader/ReaderV2Layout.tsx
@app/[locale]/reader/samples/[sampleId]/v2/ReaderV2Client.tsx
@components/reader/ReadingSampleCard.tsx
@app/[locale]/reader/page.tsx

**Tech stack available:** Next.js 16, localStorage favorites pattern, React hooks
**Established patterns:** favorites.ts localStorage CRUD, cross-tab sync via storage events
**Constraining decisions:**
- Phase 38: Reader vocabulary uses favorites with category='reader' filter
- ReaderV2Client already has scroll-based progress calculation and per-story completion tracking

**Current state:**
- ReaderV2Client already tracks scroll progress via `handleScroll` (calculates 0-100%)
- Per-story completion uses `localStorage.setItem(mkll:reader-v2-complete:${sampleId}, 'true')`
- No progress persistence between sessions (scroll position lost on page reload)
- No time tracking
- Library cards (ReadingSampleCard) don't show completion status
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reading progress storage utility</name>
  <files>lib/reading-progress.ts</files>
  <action>
Create a localStorage-based reading progress storage utility following the favorites.ts pattern.

**Interface:**
```typescript
interface ReadingProgress {
  storyId: string;
  scrollPercent: number;        // 0-100, from scroll position
  timeSpentSeconds: number;     // cumulative time on page
  isCompleted: boolean;         // true when marked complete
  completedAt?: string;         // ISO timestamp
  lastReadAt: string;           // ISO timestamp of last access
}
```

**Functions to implement:**
- `readProgress(storyId: string): ReadingProgress | null` - Get progress for one story
- `readAllProgress(): ReadingProgress[]` - Get all story progress (for library display)
- `saveProgress(progress: Omit<ReadingProgress, 'lastReadAt'>)` - Upsert progress
- `markCompleted(storyId: string)` - Set isCompleted=true, completedAt=now
- `clearProgress(storyId: string)` - Remove progress for one story
- `getCompletedStoryIds(): string[]` - Get list of completed story IDs (for library)

**Storage key:** `mkll:reading-progress` (array of ReadingProgress objects)

**Pattern to follow:** See lib/favorites.ts for localStorage handling (SSR guard, try/catch, JSON parsing). Do NOT add cross-tab sync yet (keep it simple for MVP).
  </action>
  <verify>
File exists at lib/reading-progress.ts with all 6 exported functions. TypeScript compiles: `npm run type-check`
  </verify>
  <done>
- ReadingProgress interface exported
- All 6 functions implemented and exported
- SSR-safe (typeof window check)
- Type-check passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate progress tracking in ReaderV2Client</name>
  <files>app/[locale]/reader/samples/[sampleId]/v2/ReaderV2Client.tsx</files>
  <action>
Wire reading progress storage into the existing reader client component.

**Changes:**
1. Import `readProgress`, `saveProgress`, `markCompleted` from `@/lib/reading-progress`
2. On mount: Load existing progress and restore scroll position if available
3. Track time spent: Use useRef to track session start time, calculate elapsed on progress save
4. Debounced auto-save: Save progress on scroll (debounce 2s to avoid localStorage spam)
5. On mark complete: Call `markCompleted(sampleId)` in addition to existing localStorage key

**Implementation details:**
- Add `useEffect` to load progress on mount and scroll to saved position (if any)
- Add `useRef` for `sessionStartTime` (set once on mount) and `lastSaveTime` (for debounce)
- Modify `handleScroll` to debounce-save progress: only save if 2+ seconds since last save
- Keep existing `completionKey` localStorage for backward compatibility (some users may have completions stored there)
- When marking complete, migrate any existing `completionKey` state to `markCompleted()`

**Time tracking approach:**
- Calculate `timeSpentSeconds` as: (existing progress.timeSpentSeconds || 0) + (Date.now() - sessionStartTime) / 1000
- Only add time when saving progress (not on every scroll)

**Scroll restoration:**
- If `progress.scrollPercent > 0 && progress.scrollPercent < 100`, show toast "Resuming at X%" and scroll to position
- Use a ref to the scroll container (needs to be added to the outer div)
  </action>
  <verify>
1. Open a story, scroll halfway, close the tab
2. Reopen the same story - should resume near where you left off
3. Check localStorage for `mkll:reading-progress` entry
4. Verify time accumulates across sessions
  </verify>
  <done>
- Progress loads on mount
- Scroll position auto-saves (debounced)
- Time spent accumulates across sessions
- Mark complete updates reading-progress storage
- Type-check passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Display progress on library cards</name>
  <files>components/reader/ReadingSampleCard.tsx, app/[locale]/reader/page.tsx</files>
  <action>
Show completion status and resume indicator on story cards in the library.

**ReadingSampleCard changes:**
1. Add optional props: `isCompleted?: boolean`, `progressPercent?: number`
2. If `isCompleted`: Show checkmark badge (CheckCircle icon) in top-right instead of/alongside PRO badge
3. If `progressPercent > 0 && progressPercent < 100`: Show "Resume at X%" text and change CTA from "Start Reading" to "Continue Reading"
4. Badge styling: Use green/emerald for completed checkmark

**Reader page changes (app/[locale]/reader/page.tsx):**
1. Import `readAllProgress`, `getCompletedStoryIds` from `@/lib/reading-progress`
2. Add `useEffect` to load progress on mount (client-side only)
3. Pass `isCompleted` and `progressPercent` to each ReadingSampleCard
4. Completed stories should show "Read again" instead of "Start Reading"

**CTA text logic:**
- isCompleted → "Read again" (locale-aware: "Прочитај повторно")
- progressPercent > 0 → "Continue Reading" (locale-aware: "Продолжи со читање")
- default → "Start Reading" (existing)

**Visual hierarchy:**
- Completed checkmark: Top-right corner, green CheckCircle, positioned like PRO badge
- Progress indicator: Small text below metadata row "Resumed at 45%"
  </action>
  <verify>
1. Complete a story (mark complete)
2. Return to library - card should show green checkmark and "Read again" CTA
3. Start reading a different story, scroll halfway, return to library
4. Card should show "Continue Reading" and "Resumed at X%"
  </verify>
  <done>
- ReadingSampleCard accepts isCompleted and progressPercent props
- Completed stories show green checkmark badge
- In-progress stories show "Continue Reading" CTA
- Type-check passes
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] Open story → scroll → close → reopen → position restored
- [ ] Mark complete → library shows checkmark
- [ ] Time spent accumulates across sessions
- [ ] No console errors in browser
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Reading progress persists across sessions via localStorage
- Library cards show completion status and resume position
- Backward compatible with existing `mkll:reader-v2-complete:*` keys
</success_criteria>

<output>
After completion, create `.planning/phases/39-reading-progress/39-01-SUMMARY.md` following the summary template structure with frontmatter including:
- phase, plan, subsystem (reader)
- tags: [reading-progress, localStorage, resume]
- requires: Phase 38 (reader vocabulary save)
- provides: Story progress tracking and persistence
- affects: Phase 40 (discovery & navigation), Phase 41 (content & validation)
- key-files: lib/reading-progress.ts, ReaderV2Client.tsx, ReadingSampleCard.tsx
</output>

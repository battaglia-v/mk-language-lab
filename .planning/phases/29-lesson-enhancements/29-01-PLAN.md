---
phase: 29-lesson-enhancements
plan: 01
type: execute
---

<objective>
Wire save-to-glossary functionality on vocabulary cards and add vocabulary sort toggle.

Purpose: Enable users to save words directly from lesson vocabulary sections to their personal glossary for SRS practice, improving the learn-to-practice flow. Add sorting options for better vocabulary browsing.
Output: Vocabulary cards with working "Save to Glossary" buttons, sort toggle (alphabetical/category/part-of-speech), toast feedback.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-navigation-overhaul/28-03-SUMMARY.md

# Key files for this phase:
@components/learn/LessonPageContentV2.tsx
@components/learn/EnhancedVocabularyCard.tsx
@components/practice/useVocabulary.ts
@app/api/user/vocabulary/route.ts

**Prior context:**
- EnhancedVocabularyCard already has `onAddToReview` and `isInReviewDeck` props but they're not connected in LessonPageContentV2
- useVocabulary hook provides `saveWord()` function with source tracking ('practice' | 'reader' | 'translator' | 'manual')
- API accepts source='manual' for words saved from lessons
- Vocabulary is currently grouped by category or alphabetically
- i18n keys exist: `learn.saveWord`, `quickActions`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire save-to-glossary on vocabulary cards</name>
  <files>components/learn/LessonPageContentV2.tsx</files>
  <action>
1. Import `useVocabulary` hook from `@/components/practice/useVocabulary`
2. Import `useSession` from `next-auth/react` to check auth status
3. Import `toast` from `sonner` for feedback
4. Add hook usage at component top: `const { saveWord, vocabulary } = useVocabulary()`
5. Create a Set of saved word IDs for quick lookup: `const savedWordIds = useMemo(() => new Set(vocabulary.map(w => w.wordMk)), [vocabulary])`
6. Create handler function:
```typescript
const handleSaveWord = useCallback(async (item: VocabularyItem) => {
  const result = await saveWord({
    wordMk: item.macedonianText,
    wordEn: item.englishText,
    phonetic: item.transliteration || item.pronunciation || undefined,
    source: 'manual',
    sourceId: lesson.id,
  });
  if (result) {
    toast.success(t('vocabulary.wordSaved', { word: item.macedonianText }));
  }
}, [saveWord, lesson.id, t]);
```
7. In vocabulary section rendering (case 'vocabulary'), pass props to EnhancedVocabularyCard:
   - `onAddToReview={status === 'authenticated' ? handleSaveWord : undefined}`
   - `isInReviewDeck={savedWordIds.has(item.macedonianText)}`
8. Only show save button when user is authenticated (onAddToReview is undefined for guests)

**What to avoid:** Don't create a new API endpoint - use existing `/api/user/vocabulary` with source='manual'. Don't use localStorage - vocabulary is server-persisted.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Log in as test user
3. Navigate to any lesson with vocabulary (e.g., /en/lesson/[id])
4. In vocabulary section, tap a card - verify "Add to Review" button appears
5. Click "Add to Review" - verify toast shows success
6. Verify button changes to "In Review Deck" (disabled state)
7. Navigate to Practice > My Saved Words - verify word appears
  </verify>
  <done>
- Vocabulary cards show "Add to Review" button for authenticated users
- Clicking saves word via API with source='manual'
- Toast feedback confirms save
- Button state reflects whether word is already saved
- Guests see no save button (graceful degradation)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add vocabulary sort toggle</name>
  <files>components/learn/LessonPageContentV2.tsx, messages/en.json, messages/mk.json</files>
  <action>
1. Add sort state at component top:
```typescript
type VocabSortMode = 'category' | 'alphabetical' | 'partOfSpeech';
const [vocabSortMode, setVocabSortMode] = useState<VocabSortMode>('category');
```

2. Update `groupedVocabulary` useMemo to accept sort mode:
```typescript
const groupedVocabulary = useMemo(() => {
  const filteredItems = filterVocabularyForDisplay(lesson.vocabularyItems);

  // Sort by selected mode
  if (vocabSortMode === 'alphabetical') {
    // Group by first letter
    const alphabetGroups: Record<string, VocabularyItem[]> = {};
    filteredItems.forEach(item => {
      const firstLetter = item.macedonianText.charAt(0).toUpperCase();
      if (!alphabetGroups[firstLetter]) alphabetGroups[firstLetter] = [];
      alphabetGroups[firstLetter].push(item);
    });
    return { groups: alphabetGroups, uncategorized: [], totalCount: filteredItems.length, sortMode: 'alphabetical' };
  }

  if (vocabSortMode === 'partOfSpeech') {
    // Group by part of speech
    const posGroups: Record<string, VocabularyItem[]> = {};
    const noPos: VocabularyItem[] = [];
    filteredItems.forEach(item => {
      if (item.partOfSpeech) {
        const pos = item.partOfSpeech.toLowerCase();
        if (!posGroups[pos]) posGroups[pos] = [];
        posGroups[pos].push(item);
      } else {
        noPos.push(item);
      }
    });
    return { groups: posGroups, uncategorized: noPos, totalCount: filteredItems.length, sortMode: 'partOfSpeech' };
  }

  // Default: category grouping (existing logic)
  // ... keep existing category grouping code
}, [lesson.vocabularyItems, vocabSortMode]);
```

3. Add sort toggle UI in vocabulary section header (after the word count):
```tsx
<div className="flex items-center gap-2">
  <span className="text-sm text-muted-foreground">{groupedVocabulary.totalCount} words</span>
  <div className="flex items-center gap-1 border rounded-lg p-0.5">
    <Button
      variant={vocabSortMode === 'category' ? 'secondary' : 'ghost'}
      size="sm"
      className="h-7 px-2 text-xs"
      onClick={() => setVocabSortMode('category')}
    >
      {t('vocabulary.sortCategory')}
    </Button>
    <Button
      variant={vocabSortMode === 'alphabetical' ? 'secondary' : 'ghost'}
      size="sm"
      className="h-7 px-2 text-xs"
      onClick={() => setVocabSortMode('alphabetical')}
    >
      A-Ш
    </Button>
    <Button
      variant={vocabSortMode === 'partOfSpeech' ? 'secondary' : 'ghost'}
      size="sm"
      className="h-7 px-2 text-xs"
      onClick={() => setVocabSortMode('partOfSpeech')}
    >
      {t('vocabulary.sortPos')}
    </Button>
  </div>
</div>
```

4. Add i18n keys to messages/en.json under "learn" or "vocabulary" section:
```json
"vocabulary": {
  "sortCategory": "Category",
  "sortPos": "Type",
  "wordSaved": "Saved \"{word}\" to your glossary"
}
```

5. Add corresponding Macedonian translations to messages/mk.json:
```json
"vocabulary": {
  "sortCategory": "Категорија",
  "sortPos": "Вид",
  "wordSaved": "Зачувано \"{word}\" во вашиот речник"
}
```

**What to avoid:** Don't persist sort preference to localStorage or database - keep it session-only for simplicity. Don't add complex animations for sort transitions.
  </action>
  <verify>
1. Navigate to lesson with vocabulary
2. Verify three sort buttons appear: Category, A-Ш, Type
3. Click "A-Ш" - verify vocabulary regroups alphabetically by first Cyrillic letter
4. Click "Type" - verify vocabulary groups by part of speech (noun, verb, etc.)
5. Click "Category" - verify returns to category grouping
6. Verify selected button has visual highlight (secondary variant)
7. Run `npm run lint` - no errors
8. Run `npm run type-check` - no TypeScript errors
  </verify>
  <done>
- Sort toggle appears in vocabulary section header
- Three options: Category (default), A-Ш (alphabetical), Type (part of speech)
- Vocabulary dynamically regroups based on selection
- Visual feedback shows active sort mode
- i18n strings added for both locales
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Save-to-glossary functionality and vocabulary sort toggle in lesson UI</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. Log in as a test user
    3. Navigate to: http://localhost:3000/en/learn and select any lesson with vocabulary
    4. In vocabulary section:
       - Verify sort toggle appears (Category / A-Ш / Type buttons)
       - Click each sort option - vocabulary should regroup accordingly
       - Tap a vocabulary card to expand it
       - Verify "Add to Review" button appears at bottom of card
    5. Click "Add to Review":
       - Verify toast shows "Saved [word] to your glossary"
       - Verify button changes to "In Review Deck" (disabled)
    6. Navigate to Practice > My Saved Words:
       - Verify the word you saved appears in the list
    7. Return to same lesson:
       - Verify the card still shows "In Review Deck" (persisted state)
    8. Test as guest (sign out):
       - Verify sort toggle still works
       - Verify "Add to Review" button is NOT shown for guests
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] `npm run type-check` passes
- [ ] Save-to-glossary works for authenticated users
- [ ] Sort toggle works with all three modes
- [ ] Guests see vocabulary but no save buttons
- [ ] i18n strings present in both en.json and mk.json
</verification>

<success_criteria>

- Save-to-glossary wired on vocabulary cards via useVocabulary hook
- Sort toggle (Category/A-Ш/Type) functional
- Toast feedback on save action
- Button state reflects saved status
- i18n complete for both locales
- All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/29-lesson-enhancements/29-01-SUMMARY.md`:

# Phase 29-01: Vocabulary Save & Sort Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

[Ready for Phase 30 or next plan]
</output>

---
phase: 60-qa-validation
plan: 02
type: execute
---

<objective>
Implement ALL user feedback from comprehensive QA audit - P0 critical bugs, P1 quality fixes, P2 polish items.

Purpose: Fix exercise validation, completion flows, TWA verification, and implement UX improvements.
Output: Working exercise system, proper answer validation, polished UI with MK flag branding.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/60-qa-validation/BACKLOG.md

**Key Files Identified:**
- Exercise validation: `lib/lesson-runner/useLessonRunner.ts`
- Step components: `components/lesson/steps/*.tsx`
- Unicode normalization: `lib/unicode-normalize.ts`
- Lesson completion: `components/lesson/steps/Summary.tsx`
- TWA config: `android-twa/twa-manifest.json`
- Header branding: `components/shell/ShellHeader.tsx`
- Language switcher: `components/LanguageSwitcher.tsx`
- Onboarding: `app/[locale]/(auth)/onboarding/page.tsx`
</context>

<tasks>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- P0: CRITICAL - Release Blockers -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<task type="auto">
  <name>Task 1: Fix TWA red banner - Update twa-manifest.json</name>
  <files>android-twa/twa-manifest.json</files>
  <action>
Fix the TWA manifest to eliminate red Chrome banner:

1. Change `themeColor` from `"#D32F2F"` to `"#080B12"`
2. Change `themeColorDark` from `"#D32F2F"` to `"#080B12"`
3. Change `orientation` from `"portrait-primary"` to `"default"`
4. Add fingerprints array with both signing keys:
```json
"fingerprints": [
  "4C:6D:EA:CF:77:55:3A:40:09:D8:94:5E:97:D1:9A:FC:8C:7D:B8:28:03:1F:A8:EC:6B:9F:73:FC:44:F7:D2:02",
  "4F:BB:96:B7:2A:3A:56:8D:5D:71:6F:07:2F:B4:21:91:3A:44:80:05:8B:D8:8E:33:41:83:F5:75:1D:F4:61:58"
]
```
  </action>
  <verify>grep themeColor android-twa/twa-manifest.json shows #080B12</verify>
  <done>twa-manifest.json has dark theme colors and fingerprints</done>
</task>

<task type="auto">
  <name>Task 2: Exercise state machine - Stop auto-validation on keystroke</name>
  <files>
    - components/lesson/steps/FillBlank.tsx
    - components/lesson/steps/SentenceBuilder.tsx
    - components/lesson/steps/ErrorCorrection.tsx
    - components/lesson/steps/MultipleChoice.tsx
  </files>
  <action>
**Problem:** Exercises auto-validate on onChange, showing "Not quite" after first character.

**Fix for each component:**

1. **FillBlank.tsx:**
   - Remove auto-submit on change
   - Add explicit "Check" button
   - Only validate when Check is pressed
   - Handle IME composition (ignore during compositionstart ‚Üí compositionend)
   - Keep input editable until submitted

2. **SentenceBuilder.tsx:**
   - Remove auto-submit when all words selected
   - Add explicit "Check" button
   - Validate only on Check press

3. **ErrorCorrection.tsx:**
   - Remove auto-submit on word tap
   - Show selected word highlighted
   - Add explicit "Check" button

4. **MultipleChoice.tsx:**
   - Ensure tap selects option (highlighted state)
   - Add explicit "Check" button (disabled until selection)
   - Validate only on Check press

**State machine for all exercises:**
```
idle ‚Üí answering (user interacting) ‚Üí submitted (Check pressed) ‚Üí feedback
```

**UI Copy (exact):**
- Primary button (pre-submit): "Check"
- Primary button (post-feedback correct): "Continue"
- Secondary button (post-wrong): "Try again"
- Multiple choice instruction: "Tap an option, then press Check."
- Sentence builder instruction: "Tap the tiles to build the sentence."
  </action>
  <verify>On FillBlank, typing a single character does NOT show error feedback</verify>
  <done>All exercise types require explicit Check button to validate</done>
</task>

<task type="auto">
  <name>Task 3: Fix Lesson Completion CTAs - ensure navigation works</name>
  <files>
    - components/lesson/steps/Summary.tsx
    - components/gamification/SessionCompleteModal.tsx
  </files>
  <action>
**Problem:** Completion screen CTAs are stuck or don't navigate.

**Fix:**
1. Ensure "Continue" button has working onClick/href
2. Add loading state during navigation
3. Ensure button isn't behind overlays (check z-index)
4. Remove any disabled states that never flip
5. Add fallback "Back to lessons" link

**UI Copy (exact):**
- Header: "Lesson complete!"
- Primary CTA: "Continue" (routes to next lesson or lesson list)
- Secondary CTA: "Back to lessons" (always available)

**Implementation:**
```tsx
// Continue should:
// 1. If nextLesson exists ‚Üí navigate to /lesson/[nextLessonId]
// 2. Else ‚Üí navigate to /learn (lesson list)
// 3. Show loading spinner during navigation
// 4. Never be disabled without clear reason
```
  </action>
  <verify>On completion screen, tapping Continue navigates within 300ms or shows loading</verify>
  <done>Completion screen CTAs always work and navigate properly</done>
</task>

<task type="auto">
  <name>Task 4: Progress save error handling - graceful degradation</name>
  <files>
    - lib/gamification/xp.ts
    - hooks/useGameProgress.ts
    - components/lesson/steps/Summary.tsx
  </files>
  <action>
**Problem:** Progress save errors block user flow with ugly error messages.

**Fix:**
1. Wrap all progress save calls in try/catch
2. Add retry with exponential backoff (up to 3 attempts)
3. If save fails, DON'T block user - allow continue
4. Queue failed saves in localStorage for later sync
5. Show non-blocking toast on failure

**UI Copy (exact):**
- Toast on failure: "Saving failed ‚Äî we'll retry automatically."
- Secondary line: "You can keep going."

**Implementation:**
```typescript
// In progress save functions:
try {
  await saveProgress(data);
} catch (error) {
  // Queue for retry
  queuePendingProgress(data);
  // Show toast but don't block
  toast.info("Saving failed ‚Äî we'll retry automatically.");
  // Allow user to continue
}
```

Create helper for pending progress queue in localStorage.
  </action>
  <verify>Simulate offline: progress save fails ‚Üí toast shown ‚Üí user can continue</verify>
  <done>Progress save failures don't block user flow</done>
</task>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- P1: QUALITY - Answer Evaluation & Content -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<task type="auto">
  <name>Task 5: Answer evaluation - multiple correct answers + normalization</name>
  <files>
    - lib/unicode-normalize.ts
    - lib/validation/unified-validator.ts
    - lib/lesson-runner/useLessonRunner.ts
  </files>
  <action>
**Problem:** Correct answers marked wrong (e.g., "–¢–∞–∞ –µ —Å—Ç—É–¥–µ–Ω—Ç" vs "–¢–∞–∞ –µ —Å—Ç—É–¥–µ–Ω—Ç–∫–∞").

**Fix:**
1. Ensure `acceptedAnswers: string[]` is used throughout (not just single correctAnswer)
2. Enhance normalization:
   - trim whitespace
   - collapse multiple spaces
   - ignore trailing punctuation `.?!` (configurable)
   - case-insensitive where appropriate
   - handle Cyrillic variations

3. Support "preferred" answer with educational note:
   - Accept alternative but show helpful hint

**UI Copy (exact):**
- When alternative accepted:
  - "Correct!"
  - Helper note: "'–°—Ç—É–¥–µ–Ω—Ç–∫–∞' is the feminine form. '–°—Ç—É–¥–µ–Ω—Ç' is also commonly used."
- If punctuation-only mismatch:
  - "Correct (punctuation ignored)."

**Verify existing normalizeForComparison() handles:**
- Diacritics
- Parentheticals
- Whitespace
- Punctuation
  </action>
  <verify>Typing "–¢–∞–∞ –µ —Å—Ç—É–¥–µ–Ω—Ç" is accepted when alternatives include it</verify>
  <done>Multiple correct answers work with proper feedback</done>
</task>

<task type="auto">
  <name>Task 6: Fix "Fix the mistake" content display</name>
  <files>
    - components/lesson/steps/ErrorCorrection.tsx
    - components/learn/ExerciseSection.tsx
  </files>
  <action>
**Problem:** Feedback shows partial word ("–î–æ–±—Ä–æ") instead of full corrected phrase ("–î–æ–±—Ä–æ —É—Ç—Ä–æ!").

**Fix:**
1. Update ErrorCorrection component to show FULL corrected sentence in feedback
2. Schema should have: promptOriginal, correctFull, explanation
3. Display format: "Correct: [full corrected phrase]"

**UI Copy (exact):**
- Feedback label: "Correct:"
- Example output: "Correct: –î–æ–±—Ä–æ —É—Ç—Ä–æ!"
- (NOT just "–î–æ–±—Ä–æ")
  </action>
  <verify>Error correction feedback shows full corrected phrase</verify>
  <done>Fix the mistake shows complete corrected sentence</done>
</task>

<task type="auto">
  <name>Task 7: Word Bank/Sentence Builder - fix mixed scripts + labels</name>
  <files>
    - components/lesson/steps/SentenceBuilder.tsx
    - components/learn/ExerciseSection.tsx
  </files>
  <action>
**Problem:**
1. "Arrange the words Words:" - duplicated label
2. Mixed scripts (Latin "jac" instead of Cyrillic "—ò–∞—Å")

**Fix:**
1. Clean prompt labels - remove duplicate "Words:"
2. Ensure all Macedonian tokens use Cyrillic script (validate in component)
3. Add script validation warning in dev mode

**UI Copy (exact):**
- Header: "Arrange the words"
- Subtext: "Tap the tiles to build the sentence."
- Button: "Check" / "Continue"

**Implementation:**
```tsx
// Clean header
<h3>Arrange the words</h3>
<p className="text-muted-foreground">Tap the tiles to build the sentence.</p>

// Validate Cyrillic in dev
if (process.env.NODE_ENV === 'development') {
  tokens.forEach(token => {
    if (/[a-zA-Z]/.test(token)) {
      console.warn(`Mixed script detected: "${token}" contains Latin characters`);
    }
  });
}
```
  </action>
  <verify>No duplicate "Words:" label; tokens are all Cyrillic</verify>
  <done>Word bank displays correctly without script mixing</done>
</task>

<task type="auto">
  <name>Task 8: Onboarding - add translation language selection</name>
  <files>
    - app/[locale]/(auth)/onboarding/page.tsx
    - components/settings/LanguageSettings.tsx (create if needed)
  </files>
  <action>
**Problem:** Users ask "Is it only Macedonian‚ÄìEnglish?" Want clarity on translation language.

**Fix:**
1. Add "Translation language" step in onboarding
2. For now, only English selectable with "More coming soon" note
3. Persist preference in localStorage and user profile
4. Add same setting to Settings page

**UI Copy (exact):**
- Onboarding title: "Choose your translation language"
- Option: "English" (with checkmark, selected by default)
- Helper text: "More languages are coming soon."
- Settings label: "Translation language"
  </action>
  <verify>Onboarding shows translation language step; preference persists</verify>
  <done>Translation language selection added to onboarding and settings</done>
</task>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- P2: POLISH - Branding & UX -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<task type="auto">
  <name>Task 9: Add MK flag to branding</name>
  <files>
    - components/shell/ShellHeader.tsx
    - components/layout/TopNav.tsx
    - app/[locale]/page.tsx (home hero)
  </files>
  <action>
**Goal:** Add üá≤üá∞ flag next to "–º–∞–∫–µ–¥–æ–Ω—Å–∫–∏" in header for clear Macedonian identity.

**Changes:**
1. ShellHeader.tsx - Add flag before "–º–∞–∫–µ–¥–æ–Ω—Å–∫–∏":
```tsx
<span className="title-gradient text-xl sm:text-2xl lowercase whitespace-nowrap">
  üá≤üá∞ –º–∞–∫–µ–¥–æ–Ω—Å–∫–∏
</span>
```

2. Home page hero - Add flag to title:
```tsx
<h1>üá≤üá∞ Learn Macedonian</h1>
```

3. Ensure flag emoji renders correctly on all platforms
  </action>
  <verify>Mobile header shows üá≤üá∞ flag before "–º–∞–∫–µ–¥–æ–Ω—Å–∫–∏"</verify>
  <done>MK flag visible in header branding</done>
</task>

<task type="auto">
  <name>Task 10: Clarify locked vs available content</name>
  <files>
    - components/learn/LearnPageClient.tsx
    - components/learn/LessonCard.tsx (or equivalent)
    - components/ui/empty-state.tsx
  </files>
  <action>
**Problem:** Users feel content is hidden/locked without explanation.

**Fix:**
1. If content is unavailable, show card with lock icon and explanation
2. Use ComingSoonState component for future content
3. Ensure users always have a path forward (no dead ends)

**UI Copy (exact):**
- Locked label: "Locked"
- Description: "Coming soon. Finish earlier lessons to unlock."
- Alternative: "Coming soon in the next update."
- Button: "Back to lessons"

**For B1 Advanced specifically:**
- Show "Coming Soon" badge on B1 level card
- Card still visible but grayed with badge
  </action>
  <verify>Locked content shows explanation; B1 has "Coming Soon" badge</verify>
  <done>Locked content clearly explained with path forward</done>
</task>

<task type="auto">
  <name>Task 11: Add Alpha banner for monetization scaffold</name>
  <files>
    - components/layout/AlphaBanner.tsx (create)
    - app/[locale]/layout.tsx or app/[locale]/learn/layout.tsx
  </files>
  <action>
**Goal:** Keep alpha frictionless but prepare for future monetization.

**Fix:**
1. Create simple AlphaBanner component
2. Show at top of authenticated pages (dismissible)
3. Store dismissal in localStorage

**UI Copy (exact):**
- Banner text: "Alpha: Everything is free while we improve the app."
- Dismiss button: "√ó" (X icon)

**Implementation:**
```tsx
export function AlphaBanner() {
  const [dismissed, setDismissed] = useState(() =>
    localStorage.getItem('alpha-banner-dismissed') === 'true'
  );

  if (dismissed) return null;

  return (
    <div className="bg-brand-gold/20 text-brand-gold-dark px-4 py-2 text-center text-sm">
      <span>Alpha: Everything is free while we improve the app.</span>
      <button onClick={() => {
        localStorage.setItem('alpha-banner-dismissed', 'true');
        setDismissed(true);
      }} className="ml-4">√ó</button>
    </div>
  );
}
```
  </action>
  <verify>Alpha banner shows on learn page; can be dismissed</verify>
  <done>Alpha banner visible with dismissible functionality</done>
</task>

<task type="auto">
  <name>Task 12: Hide mission error banner for unauthenticated users</name>
  <files>
    - hooks/useMissionStatus.ts
    - components/layout/TopNav.tsx
  </files>
  <action>
**Problem:** Red mission error banner shows for guests when API fails.

**Fix:**
1. In useMissionStatus hook, check auth state first
2. For unauthenticated users, return `state: 'hidden'` (not 'error')
3. For authenticated users with API failure, use graceful degradation (cached data)
4. Remove red styling for degraded state - use neutral colors

**Implementation:**
```typescript
// In useMissionStatus.ts
if (!session?.user) {
  return { state: 'hidden', mission: defaultMission };
}

// On error for authenticated:
setState('degraded'); // Not 'error'
// Use cached/default data without red banner
```

In TopNav, don't render MissionSummaryBanner if state === 'hidden'.
  </action>
  <verify>Visit /en/learn as guest - no red mission banner visible</verify>
  <done>Mission banner hidden for guests, graceful degradation for auth users</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] twa-manifest.json has dark colors (#080B12) and fingerprints
- [ ] Exercise types require explicit "Check" button (no auto-validation)
- [ ] Completion screen CTAs navigate properly
- [ ] Progress save failures don't block user
- [ ] Multiple correct answers accepted with proper feedback
- [ ] Error correction shows full corrected phrase
- [ ] Word bank has no duplicate labels or mixed scripts
- [ ] Onboarding has translation language step
- [ ] üá≤üá∞ flag visible in header
- [ ] Locked content shows "Coming Soon" explanation
- [ ] Alpha banner visible and dismissible
- [ ] No red mission banner for guests
- [ ] npm run type-check passes
- [ ] npm run lint passes
</verification>

<success_criteria>
- All 12 tasks completed
- All P0 critical bugs fixed
- All P1 quality issues addressed
- All P2 polish items implemented
- Type checking and linting pass
</success_criteria>

<output>
After completion, create `.planning/phases/60-qa-validation/60-02-SUMMARY.md`

Commit format: `feat(60-02): [task-description]`
</output>

---
phase: 63-practice-flow
plan: 04
type: execute
---

<objective>
Offline answer queue and session persistence.

Purpose: Enable practice sessions to work offline and persist across app restarts.
Output: Local storage queue for answer submission, session restore functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/63-practice-flow/63-03-SUMMARY.md

# Mobile storage:
@apps/mobile/lib/storage.ts

# Web session persistence patterns:
@lib/session-persistence.ts

# Practice lib:
@apps/mobile/lib/practice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create offline queue storage</name>
  <files>apps/mobile/lib/offline-queue.ts</files>
  <action>
Build offline queue for practice completion events using AsyncStorage.

```typescript
type QueuedEvent = {
  id: string;
  timestamp: number;
  data: {
    deckType: string;
    mode: string;
    correct: number;
    total: number;
    accuracy: number;
    xpEarned: number;
    durationMs: number;
  };
  retryCount: number;
};

export async function queuePracticeCompletion(data: QueuedEvent['data']): Promise<void>;
export async function getQueuedEvents(): Promise<QueuedEvent[]>;
export async function removeFromQueue(id: string): Promise<void>;
export async function processQueue(): Promise<{ success: number; failed: number }>;
```

Storage key: `@mklanguage/practice-queue`

processQueue:
- Fetch all queued events
- Attempt to submit each to API
- Remove successful ones
- Increment retryCount for failed ones
- Return counts

Max retries: 3 (remove after 3 failures).
  </action>
  <verify>Queue functions save/retrieve events from AsyncStorage</verify>
  <done>Offline queue stores and processes practice completions</done>
</task>

<task type="auto">
  <name>Task 2: Create session persistence</name>
  <files>apps/mobile/lib/session-persistence.ts</files>
  <action>
Build session persistence for interrupted practice sessions.

```typescript
type PersistedSession = {
  id: string;
  deck: string;
  mode: string;
  cards: PracticeCard[];
  currentIndex: number;
  correct: number;
  incorrect: number;
  startTime: number;
  lastUpdated: number;
};

export async function saveSession(session: PersistedSession): Promise<void>;
export async function loadSession(): Promise<PersistedSession | null>;
export async function clearSession(): Promise<void>;
export function isSessionStale(session: PersistedSession, maxAgeHours?: number): boolean;
```

Storage key: `@mklanguage/practice-session`

Auto-save on each answer (debounced 500ms).
Clear on session complete.
Session stale after 24 hours.
  </action>
  <verify>Session saves and restores from storage</verify>
  <done>Session persistence saves progress, loads on app restart</done>
</task>

<task type="auto">
  <name>Task 3: Integrate offline queue and session restore</name>
  <files>apps/mobile/app/practice/session.tsx, apps/mobile/app/_layout.tsx</files>
  <action>
Integrate offline queue and session restore into the app.

In session.tsx:
- On mount: Check for persisted session, offer to resume if found
- On answer: Auto-save session state
- On complete: Queue completion event, then attempt immediate sync
- Clear persisted session on complete

Resume prompt UI:
```
"Resume Practice?"
"You have an unfinished session (5/10 cards)"
[Resume] [Start Fresh]
```

In _layout.tsx (root layout):
- On app start: Call processQueue() to sync any pending completions
- Silent background operation, don't block UI

Update submitPracticeCompletion in lib/practice.ts:
- Try API first
- On failure: Queue locally
- Return success (UI doesn't need to know about queue)
  </action>
  <verify>Session restores after app restart, queued events sync on app launch</verify>
  <done>Full offline support with session restore and event queue</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes in apps/mobile
- [ ] Practice session auto-saves progress
- [ ] Reopening app shows resume prompt for unfinished session
- [ ] Offline completions sync when online
- [ ] Queue processes on app launch
</verification>

<success_criteria>

- Offline queue persists practice completions
- Session state survives app restart
- Resume prompt offers to continue unfinished session
- Background sync processes queue silently
- Phase 63 Practice Flow complete
</success_criteria>

<output>
After completion, create `.planning/phases/63-practice-flow/63-04-SUMMARY.md`
</output>

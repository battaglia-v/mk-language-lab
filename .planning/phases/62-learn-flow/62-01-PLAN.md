---
phase: 62-learn-flow
plan: 01
type: execute
---

<objective>
Build the Learn screen UI with level selector and lesson list.

Purpose: Enable users to browse curriculum paths (A1/A2/B1) and see their progress.
Output: Working Learn tab with level tabs, lesson list, and progress indicators.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/61-foundation/summary.md

# Web Learn page (reference)
@components/learn/LearnPageClient.tsx
@lib/learn/lesson-path-types.ts
@lib/learn/curriculum-path.ts

# Existing mobile files
@apps/mobile/app/(tabs)/learn.tsx
@apps/mobile/lib/api.ts

# Existing APIs
@app/api/user/progress/route.ts
@app/api/user/journey-progress/route.ts

**Dependencies from 61-03:**
- Tab navigation with Learn tab placeholder
- API client with token auth
- Progress API stub in lib/progress.ts

**Key patterns:**
- Use StyleSheet.create (not NativeWind) - established in 61-02
- Use Zustand for state management
- Fetch from existing /api/user/progress and /api/user/journey-progress endpoints
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mobile curriculum API endpoint</name>
  <files>app/api/mobile/curriculum/route.ts</files>
  <action>
Create `/api/mobile/curriculum` endpoint that returns curriculum paths for all levels.

1. Create `app/api/mobile/curriculum/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { verifyMobileAuthToken } from '@/lib/mobile-auth-token';
import { getA1Path, getA2Path, getB1Path } from '@/lib/learn/curriculum-path';

export async function GET(request: NextRequest) {
  // Verify mobile auth token
  const authHeader = request.headers.get('Authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const token = authHeader.slice(7);
  const payload = await verifyMobileAuthToken(token);
  if (!payload) {
    return NextResponse.json({ error: 'Invalid token' }, { status: 401 });
  }

  const userId = payload.id;

  // Fetch all curriculum paths with user progress
  const [a1Path, a2Path, b1Path] = await Promise.all([
    getA1Path(userId),
    getA2Path(userId),
    getB1Path(userId),
  ]);

  return NextResponse.json({
    paths: {
      a1: a1Path,
      a2: a2Path,
      b1: b1Path,
    },
  });
}
```

This reuses existing `getCurriculumPath` functions that already handle:
- Fetching modules/lessons from database
- User completion status lookup
- Node status calculation (locked/available/completed)
  </action>
  <verify>curl -H "Authorization: Bearer {token}" http://localhost:3000/api/mobile/curriculum returns JSON with paths</verify>
  <done>Mobile curriculum API returns a1/a2/b1 paths with user progress</done>
</task>

<task type="auto">
  <name>Task 2: Create Learn screen with level selector and lesson list</name>
  <files>apps/mobile/app/(tabs)/learn.tsx, apps/mobile/lib/curriculum.ts, apps/mobile/components/LessonCard.tsx</files>
  <action>
1. Create `apps/mobile/lib/curriculum.ts` with types and fetch:

```typescript
import { apiFetch } from './api';

export type LessonNodeStatus = 'locked' | 'available' | 'in_progress' | 'completed';

export interface LessonNode {
  id: string;
  type: 'lesson' | 'review' | 'story' | 'checkpoint';
  title: string;
  titleMk?: string;
  description?: string;
  status: LessonNodeStatus;
  xpReward: number;
  href?: string;
  contentId?: string;
  progress?: number;
}

export interface LessonPath {
  id: string;
  title: string;
  description?: string;
  nodes: LessonNode[];
  completedCount: number;
  totalCount: number;
}

export interface CurriculumPaths {
  a1: LessonPath;
  a2: LessonPath;
  b1: LessonPath;
}

export async function fetchCurriculum(): Promise<CurriculumPaths> {
  const response = await apiFetch<{ paths: CurriculumPaths }>('/api/mobile/curriculum');
  return response.paths;
}
```

2. Create `apps/mobile/components/LessonCard.tsx`:

```typescript
import { View, Text, TouchableOpacity, StyleSheet } from 'react-native';
import { Check, Lock, Play, BookOpen } from 'lucide-react-native';
import type { LessonNode } from '../lib/curriculum';

interface LessonCardProps {
  node: LessonNode;
  onPress: () => void;
}

export function LessonCard({ node, onPress }: LessonCardProps) {
  const isLocked = node.status === 'locked';
  const isCompleted = node.status === 'completed';
  const isAvailable = node.status === 'available' || node.status === 'in_progress';

  return (
    <TouchableOpacity
      style={[styles.card, isLocked && styles.cardLocked]}
      onPress={onPress}
      disabled={isLocked}
    >
      <View style={[styles.iconContainer, isCompleted && styles.iconCompleted]}>
        {isLocked ? (
          <Lock size={20} color="#666" />
        ) : isCompleted ? (
          <Check size={20} color="#000" />
        ) : (
          <BookOpen size={20} color="#f6d83b" />
        )}
      </View>
      <View style={styles.content}>
        <Text style={[styles.title, isLocked && styles.titleLocked]}>
          {node.title}
        </Text>
        {node.description && (
          <Text style={styles.description} numberOfLines={1}>
            {node.description}
          </Text>
        )}
      </View>
      {isAvailable && (
        <View style={styles.playButton}>
          <Play size={16} color="#f6d83b" fill="#f6d83b" />
        </View>
      )}
    </TouchableOpacity>
  );
}

const styles = StyleSheet.create({
  card: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#0b0b12',
    borderWidth: 1,
    borderColor: '#222536',
    borderRadius: 12,
    padding: 16,
    marginBottom: 12,
  },
  cardLocked: {
    opacity: 0.5,
  },
  iconContainer: {
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: '#111424',
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 12,
  },
  iconCompleted: {
    backgroundColor: '#f6d83b',
  },
  content: {
    flex: 1,
  },
  title: {
    fontSize: 16,
    fontWeight: '600',
    color: '#f7f8fb',
  },
  titleLocked: {
    color: '#666',
  },
  description: {
    fontSize: 14,
    color: 'rgba(247,248,251,0.6)',
    marginTop: 2,
  },
  playButton: {
    width: 32,
    height: 32,
    borderRadius: 16,
    backgroundColor: 'rgba(246,216,59,0.2)',
    alignItems: 'center',
    justifyContent: 'center',
  },
});
```

3. Update `apps/mobile/app/(tabs)/learn.tsx`:

```typescript
import { useEffect, useState, useCallback } from 'react';
import {
  View,
  Text,
  ScrollView,
  RefreshControl,
  TouchableOpacity,
  StyleSheet,
  ActivityIndicator,
} from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { router } from 'expo-router';
import { LessonCard } from '../../components/LessonCard';
import { fetchCurriculum, CurriculumPaths, LessonPath } from '../../lib/curriculum';

type Level = 'a1' | 'a2' | 'b1';

const LEVEL_LABELS: Record<Level, { title: string; subtitle: string }> = {
  a1: { title: 'A1', subtitle: 'Beginner' },
  a2: { title: 'A2', subtitle: 'Elementary' },
  b1: { title: 'B1', subtitle: 'Intermediate' },
};

export default function LearnScreen() {
  const [curriculum, setCurriculum] = useState<CurriculumPaths | null>(null);
  const [activeLevel, setActiveLevel] = useState<Level>('a1');
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const loadCurriculum = useCallback(async () => {
    try {
      const data = await fetchCurriculum();
      setCurriculum(data);
      setError(null);
    } catch (err) {
      setError('Failed to load curriculum');
      console.error(err);
    } finally {
      setIsLoading(false);
      setIsRefreshing(false);
    }
  }, []);

  useEffect(() => {
    loadCurriculum();
  }, [loadCurriculum]);

  const onRefresh = () => {
    setIsRefreshing(true);
    loadCurriculum();
  };

  const handleLessonPress = (lessonId: string) => {
    router.push(`/lesson/${lessonId}`);
  };

  const currentPath: LessonPath | null = curriculum ? curriculum[activeLevel] : null;

  if (isLoading) {
    return (
      <SafeAreaView style={styles.container}>
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color="#f6d83b" />
        </View>
      </SafeAreaView>
    );
  }

  return (
    <SafeAreaView style={styles.container}>
      {/* Level Tabs */}
      <View style={styles.tabsContainer}>
        {(['a1', 'a2', 'b1'] as Level[]).map((level) => (
          <TouchableOpacity
            key={level}
            style={[styles.tab, activeLevel === level && styles.tabActive]}
            onPress={() => setActiveLevel(level)}
          >
            <Text style={[styles.tabTitle, activeLevel === level && styles.tabTitleActive]}>
              {LEVEL_LABELS[level].title}
            </Text>
            <Text style={[styles.tabSubtitle, activeLevel === level && styles.tabSubtitleActive]}>
              {LEVEL_LABELS[level].subtitle}
            </Text>
          </TouchableOpacity>
        ))}
      </View>

      {/* Progress Bar */}
      {currentPath && (
        <View style={styles.progressContainer}>
          <View style={styles.progressBar}>
            <View
              style={[
                styles.progressFill,
                { width: `${(currentPath.completedCount / currentPath.totalCount) * 100}%` },
              ]}
            />
          </View>
          <Text style={styles.progressText}>
            {currentPath.completedCount} / {currentPath.totalCount} lessons
          </Text>
        </View>
      )}

      {/* Lesson List */}
      <ScrollView
        style={styles.scrollView}
        contentContainerStyle={styles.scrollContent}
        refreshControl={
          <RefreshControl
            refreshing={isRefreshing}
            onRefresh={onRefresh}
            tintColor="#f6d83b"
          />
        }
      >
        {error ? (
          <View style={styles.errorContainer}>
            <Text style={styles.errorText}>{error}</Text>
          </View>
        ) : currentPath?.nodes.map((node) => (
          <LessonCard
            key={node.id}
            node={node}
            onPress={() => handleLessonPress(node.id)}
          />
        ))}
      </ScrollView>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#06060b',
  },
  loadingContainer: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
  },
  tabsContainer: {
    flexDirection: 'row',
    paddingHorizontal: 16,
    paddingVertical: 12,
    gap: 8,
  },
  tab: {
    flex: 1,
    backgroundColor: '#0b0b12',
    borderWidth: 1,
    borderColor: '#222536',
    borderRadius: 12,
    paddingVertical: 12,
    alignItems: 'center',
  },
  tabActive: {
    backgroundColor: 'rgba(246,216,59,0.1)',
    borderColor: '#f6d83b',
  },
  tabTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: 'rgba(247,248,251,0.6)',
  },
  tabTitleActive: {
    color: '#f6d83b',
  },
  tabSubtitle: {
    fontSize: 12,
    color: 'rgba(247,248,251,0.4)',
    marginTop: 2,
  },
  tabSubtitleActive: {
    color: 'rgba(246,216,59,0.8)',
  },
  progressContainer: {
    paddingHorizontal: 16,
    paddingBottom: 16,
  },
  progressBar: {
    height: 6,
    backgroundColor: '#222536',
    borderRadius: 3,
    overflow: 'hidden',
  },
  progressFill: {
    height: '100%',
    backgroundColor: '#f6d83b',
    borderRadius: 3,
  },
  progressText: {
    fontSize: 12,
    color: 'rgba(247,248,251,0.6)',
    marginTop: 8,
    textAlign: 'center',
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    padding: 16,
  },
  errorContainer: {
    backgroundColor: 'rgba(255,120,120,0.2)',
    padding: 16,
    borderRadius: 12,
  },
  errorText: {
    color: '#ff7878',
    textAlign: 'center',
  },
});
```
  </action>
  <verify>cd apps/mobile && npx tsc --noEmit</verify>
  <done>Learn screen shows level tabs, progress bar, and lesson list with completion indicators</done>
</task>

<task type="auto">
  <name>Task 3: Create lesson route placeholder</name>
  <files>apps/mobile/app/lesson/[lessonId].tsx</files>
  <action>
Create placeholder lesson screen that will be expanded in 62-02.

1. Create the lesson route directory and file:

```typescript
// apps/mobile/app/lesson/[lessonId].tsx
import { View, Text, StyleSheet, TouchableOpacity } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useLocalSearchParams, router } from 'expo-router';
import { ChevronLeft } from 'lucide-react-native';

export default function LessonScreen() {
  const { lessonId } = useLocalSearchParams<{ lessonId: string }>();

  return (
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity style={styles.backButton} onPress={() => router.back()}>
          <ChevronLeft size={24} color="#f7f8fb" />
        </TouchableOpacity>
        <Text style={styles.headerTitle}>Lesson</Text>
        <View style={styles.backButton} />
      </View>
      <View style={styles.content}>
        <Text style={styles.title}>Lesson: {lessonId}</Text>
        <Text style={styles.subtitle}>
          Lesson runner coming in 62-02
        </Text>
      </View>
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#06060b',
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 16,
    paddingVertical: 12,
    borderBottomWidth: 1,
    borderBottomColor: '#222536',
  },
  backButton: {
    width: 40,
    height: 40,
    alignItems: 'center',
    justifyContent: 'center',
  },
  headerTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#f7f8fb',
  },
  content: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    padding: 24,
  },
  title: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#f7f8fb',
    marginBottom: 8,
  },
  subtitle: {
    fontSize: 16,
    color: 'rgba(247,248,251,0.72)',
    textAlign: 'center',
  },
});
```
  </action>
  <verify>cd apps/mobile && npx tsc --noEmit</verify>
  <done>Lesson route exists and navigates from lesson list</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes in apps/mobile
- [ ] Mobile curriculum API endpoint returns curriculum paths
- [ ] Learn screen shows level tabs (A1/A2/B1)
- [ ] Lesson list shows completion status (locked/available/completed)
- [ ] Tapping a lesson navigates to lesson screen
</verification>

<success_criteria>

- Level selector switches between A1/A2/B1 paths
- Lesson list shows proper status indicators
- Progress bar updates based on completion count
- Pull-to-refresh reloads curriculum
- Navigation to individual lessons works
</success_criteria>

<output>
After completion, create `.planning/phases/62-learn-flow/62-01-SUMMARY.md`
</output>

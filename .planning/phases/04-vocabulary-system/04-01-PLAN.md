---
phase: 04-vocabulary-system
plan: 01
type: execute
---

<objective>
Create API endpoints for vocabulary state management using existing VocabularyWord model.

Purpose: Enable server-side vocab tracking that persists across devices and sessions.
Output: GET/POST endpoints for user vocabulary with mastery states.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lesson-practice-integrity/DISCOVERY.md

# Existing VocabularyWord model (lines 860-881):
@prisma/schema.prisma

# Existing SRS logic (patterns to follow):
@lib/srs.ts

# Prior decisions:
# - [03-01]: Phase 3 is infrastructure focus; vocabulary seeding is future work
# - VocabularyWord model exists with mastery (0-5), nextReviewAt, timesReviewed, timesCorrect
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GET /api/user/vocabulary endpoint</name>
  <files>app/api/user/vocabulary/route.ts</files>
  <action>
Create GET endpoint that returns user's vocabulary words with filtering:

Query params:
- `status`: 'new' | 'learning' | 'mastered' | 'due' | 'all' (default: 'all')
- `limit`: number (default: 50, max: 200)

Mastery mapping:
- new: mastery = 0
- learning: mastery 1-3
- mastered: mastery 4-5
- due: nextReviewAt <= now

Response format:
```json
{
  "words": [{ id, wordMk, wordEn, mastery, nextReviewAt, ... }],
  "counts": { new: N, learning: N, mastered: N, due: N, total: N }
}
```

Use existing auth pattern from `/api/user/journey-progress/route.ts`.
Return empty array (not error) if user has no words.
  </action>
  <verify>npm run type-check passes; endpoint file exists</verify>
  <done>GET /api/user/vocabulary returns user vocab with counts and filtering</done>
</task>

<task type="auto">
  <name>Task 2: Create POST /api/user/vocabulary endpoint for adding words</name>
  <files>app/api/user/vocabulary/route.ts</files>
  <action>
Add POST handler to same route file for saving new words:

Request body:
```json
{
  "wordMk": "здраво",
  "wordEn": "hello",
  "phonetic": "zdravo",
  "source": "practice" | "reader" | "translator" | "manual",
  "sourceId": "optional-source-content-id"
}
```

Behavior:
- If word already exists (unique userId+wordMk), return existing record (200)
- If new, create with mastery=0, nextReviewAt=null
- Return the created/existing VocabularyWord record

Use prisma upsert pattern for clean handling.
  </action>
  <verify>npm run type-check passes; POST creates new word records</verify>
  <done>POST /api/user/vocabulary creates or returns existing vocab word</done>
</task>

<task type="auto">
  <name>Task 3: Create PATCH /api/user/vocabulary/[id] for review updates</name>
  <files>app/api/user/vocabulary/[id]/route.ts</files>
  <action>
Create dynamic route for updating vocab word after review:

PATCH /api/user/vocabulary/:id
Request body:
```json
{
  "correct": boolean
}
```

SRS logic (Leitner-style, matching lib/srs.ts):
- correct: mastery = min(mastery + 1, 5)
- incorrect: mastery = 0
- Calculate nextReviewAt based on mastery level:
  - mastery 0: 1 day
  - mastery 1: 3 days
  - mastery 2: 7 days
  - mastery 3: 14 days
  - mastery 4: 30 days
  - mastery 5: 90 days
- Increment timesReviewed, conditionally increment timesCorrect

Verify word belongs to authenticated user before updating.
Return updated word record.
  </action>
  <verify>npm run type-check && npm run lint</verify>
  <done>PATCH updates mastery and calculates next review date</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes
- [ ] `npm run lint` passes
- [ ] GET endpoint returns vocab with counts
- [ ] POST endpoint creates new words
- [ ] PATCH endpoint updates mastery correctly
</verification>

<success_criteria>

- All three API endpoints created and type-safe
- VocabularyWord model used correctly
- SRS intervals match lib/srs.ts pattern
- No TypeScript or lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-vocabulary-system/04-01-SUMMARY.md`
</output>

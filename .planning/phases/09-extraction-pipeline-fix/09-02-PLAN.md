---
phase: 09-extraction-pipeline-fix
plan: 02
type: execute
---

<objective>
Fix grammar extraction to parse actual content instead of hardcoded patterns and placeholders.

Purpose: Current A1 grammar uses only 2 hardcoded patterns (сум and possessives); A2 creates 34 placeholder notes with no real content. Grammar sections exist in the PDFs but aren't being parsed.
Output: Updated parsers that extract grammar explanations and examples from actual PDF content.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-extraction-pipeline-fix/09-01-SUMMARY.md

# Key files
@scripts/curriculum/parse-a1-structure.ts
@scripts/curriculum/parse-a2-structure.ts

# Grammar patterns from audit (raw text samples):
# Page 55 A1: "Глаголот сум - Вежба 1. Пополни ги празните места со форми од глаголот сум..."
# Page 75 A1: "именка. Вежба 1. Еднина и множина..."
# A2 TOC: Has grammar topics per lesson but parser creates empty placeholders

# Grammar content locations:
# - 27 pages in A1 contain "Глагол" or "глагол" or "именка" markers
# - 60 pages in A2 contain grammar markers
# - A2 has dedicated "Граматика" section starting page 156
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create grammar extraction utilities module</name>
  <files>scripts/curriculum/grammar-patterns.ts</files>
  <action>
Create a new module with grammar extraction functions:

1. `extractGrammarSections(text: string): Array<{title: string, content: string, page?: number}>` - Find grammar section headers (Глагол, именка, Граматика) and extract following explanation paragraphs

2. `extractGrammarExamples(text: string): string[]` - Extract numbered examples from text:
   - Pattern: а. б. в. г. д. (Cyrillic lettering)
   - Pattern: 1. 2. 3. (Arabic numerals)
   - Capture the sentence following each marker

3. `extractConjugationTables(text: string): Array<{verb: string, forms: Record<string, string>}>` - Extract verb conjugation patterns when present (e.g., Јас сум, Ти си, etc.)

Key insight: A2 already has grammar TITLES from TOC (LESSON_GRAMMAR constant) - we need to extract corresponding CONTENT from pages.
  </action>
  <verify>npx tsc --noEmit scripts/curriculum/grammar-patterns.ts</verify>
  <done>Module compiles without errors, exports 3 extraction functions</done>
</task>

<task type="auto">
  <name>Task 2: Update A1 grammar extraction with section parsing</name>
  <files>scripts/curriculum/parse-a1-structure.ts</files>
  <action>
Update extractGrammarNotes() in parse-a1-structure.ts:

1. Import functions from grammar-patterns.ts
2. Keep the existing hardcoded patterns as fallbacks (they work for 2 specific cases)
3. Add section-based extraction:
   - Scan lesson text for grammar markers (Глагол, именка, Граматика, придавка)
   - Extract explanation text following markers
   - Extract examples using extractGrammarExamples()

4. Merge results: hardcoded patterns + section-based extraction
5. Deduplicate by title

Target: Increase from 7 grammar notes to 15+ unique grammar topics
  </action>
  <verify>npx tsx scripts/curriculum/parse-a1-structure.ts 2>&1 | grep -E "(Grammar|notes)"</verify>
  <done>A1 parser extracts 15+ grammar notes (vs 7 before) with content and examples</done>
</task>

<task type="auto">
  <name>Task 3: Update A2 grammar extraction to populate placeholders</name>
  <files>scripts/curriculum/parse-a2-structure.ts</files>
  <action>
Update extractGrammarNotes() in parse-a2-structure.ts:

1. Import functions from grammar-patterns.ts
2. KEEP the existing LESSON_GRAMMAR TOC-based titles (they're accurate)
3. For each grammar title in LESSON_GRAMMAR[lessonNum]:
   - Search lesson text for the title or related keywords
   - Extract explanation paragraphs following the title
   - Extract examples using extractGrammarExamples()
   - Replace placeholder "Grammar topic covered in Lesson X" with actual content

4. Also parse the dedicated Граматика section (pages 156+) for reference content

Target: All 34 grammar notes should have real content (vs generic placeholders)
Each note should have 2+ examples (vs 0 currently)
  </action>
  <verify>npx tsx scripts/curriculum/parse-a2-structure.ts 2>&1 | grep -E "(Grammar|notes|examples)"</verify>
  <done>A2 parser produces 34 grammar notes with real content strings (not "Grammar topic covered in Lesson X") and examples arrays with entries</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run type-check` passes
- [ ] A1 extracts 15+ unique grammar notes (vs 7 before)
- [ ] A2 grammar notes have real content (check JSON for non-placeholder text)
- [ ] Grammar notes include examples arrays with 2+ entries each
- [ ] `data/curriculum/structured/a1-teskoto.json` updated with grammar content
- [ ] `data/curriculum/structured/a2-lozje.json` updated with grammar content
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- A1 grammar notes increased from 7 to 15+
- A2 grammar notes have actual explanations (not "Grammar topic covered in Lesson X")
- Grammar notes include extracted examples
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-extraction-pipeline-fix/09-02-SUMMARY.md`
</output>

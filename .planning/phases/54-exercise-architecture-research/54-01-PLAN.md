---
phase: 54-exercise-architecture-research
plan: 01
type: execute
---

<objective>
Research the current exercise architecture to produce a technical discovery document that informs phases 55-58 (Exercise State Machine, Lesson Flow Progress, Answer Evaluation, Audio Language).

Purpose: Understand the dual exercise system architecture (grammar-engine vs lesson-runner) and identify the unification path for subsequent implementation phases.
Output: DISCOVERY.md documenting current state, gaps, and recommendations.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONCERNS.md

# Exercise System Files (primary analysis targets)
@lib/grammar-engine.ts
@lib/lesson-runner/types.ts
@lib/lesson-runner/useLessonRunner.ts
@lib/lesson-runner/adapters/exercise-adapter.ts
@lib/lesson-runner/validation.ts
@components/learn/GrammarExerciseCard.tsx

# Related concerns from CONCERNS.md:
# - "lib/lesson-runner/adapters/exercise-adapter.ts: Custom exercise types need implementation"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit current exercise architecture</name>
  <files>DISCOVERY.md (create)</files>
  <action>
Analyze and document the two exercise systems:

**System A: grammar-engine.ts + GrammarExerciseCard.tsx**
- Exercise types: fill-blank, multiple-choice, sentence-builder, error-correction
- Validation: validateAnswerWithFeedback function
- UI: GrammarExerciseCard renders all 4 types
- State: Local React state (userAnswer, attempts, result)
- Used in: Practice section, lesson quiz

**System B: lesson-runner (types.ts + useLessonRunner.ts)**
- Step types: INFO, MULTIPLE_CHOICE, FILL_BLANK, TAP_WORDS, PRONOUNCE, SUMMARY
- Validation: Built into useLessonRunner hook
- UI: Step components (not yet audited)
- State: Hook-managed state (currentIndex, answers, feedback)
- Used in: Lesson sections (vocabulary, grammar)

**Document:**
1. Where each system is used (routes, components)
2. Data flow for each
3. How exercise-adapter.ts bridges them
4. The TODOs in exercise-adapter for sentence-builder and error-correction
5. Any state management inconsistencies
  </action>
  <verify>DISCOVERY.md exists with "Current Architecture" section containing both systems</verify>
  <done>Current state documented with clear system boundaries</done>
</task>

<task type="auto">
  <name>Task 2: Analyze unification gaps and recommendations</name>
  <files>DISCOVERY.md (update)</files>
  <action>
Complete the DISCOVERY.md with gap analysis and recommendations:

**Gap Analysis:**
1. Missing LessonRunner step types (sentence-builder, error-correction)
2. Validation differences between systems
3. State management inconsistencies
4. XP calculation variations
5. Progress tracking differences

**For each gap, document:**
- What's the current workaround (if any)
- Impact on user experience
- Implementation approach

**Recommendations for Phases 55-58:**
- Phase 55 (Exercise State Machine): What state needs unification
- Phase 56 (Lesson Flow Progress): How progress tracking should work
- Phase 57 (Answer Evaluation): Validation unification approach
- Phase 58 (Audio Language): Audio step implementation (PRONOUNCE)

**Format:** Use XML structure for clear parsing:
```markdown
## Gap: [Name]

### Current State
[Description]

### Impact
[User/developer impact]

### Recommendation
[Specific implementation approach]

### Target Phase
[55/56/57/58]
```
  </action>
  <verify>DISCOVERY.md has "Gaps" and "Recommendations" sections</verify>
  <done>All gaps documented with specific recommendations per phase</done>
</task>

<task type="auto">
  <name>Task 3: Create phase dependency diagram and validation</name>
  <files>DISCOVERY.md (finalize)</files>
  <action>
Add final sections to DISCOVERY.md:

**Dependency Diagram:**
```
Phase 54 (Research) ─── produces ───> DISCOVERY.md
                                           │
                    ┌──────────────────────┼──────────────────────┐
                    │                      │                      │
                    ▼                      ▼                      ▼
            Phase 55               Phase 56               Phase 57
        (State Machine)        (Lesson Flow)          (Evaluation)
                    │                      │                      │
                    └──────────────────────┼──────────────────────┘
                                           │
                                           ▼
                                      Phase 58
                                   (Audio Language)
                                           │
                                           ▼
                                    Phases 59-60
                                 (Polish & Validation)
```

**Validation Checklist:**
- [ ] All 4 grammar exercise types accounted for
- [ ] All 6 lesson-runner step types reviewed
- [ ] exercise-adapter.ts TODOs addressed in recommendations
- [ ] Each phase 55-58 has clear scope from recommendations
- [ ] No blocking dependencies between 55-57 (can parallelize if needed)

**Risk Assessment:**
- Low: Internal refactoring, no external dependencies
- Test coverage: Existing E2E tests cover current behavior
- Rollback: No database migrations required
  </action>
  <verify>DISCOVERY.md is complete with diagram, checklist, and risk assessment</verify>
  <done>DISCOVERY.md fully documented and ready for subsequent planning</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] DISCOVERY.md exists in .planning/phases/54-exercise-architecture-research/
- [ ] Contains: Current Architecture, Gaps, Recommendations, Dependency Diagram
- [ ] Each phase 55-58 has specific recommendations
- [ ] Document builds without errors (valid markdown)
</verification>

<success_criteria>
- DISCOVERY.md provides clear technical direction for phases 55-58
- All exercise types from both systems accounted for
- Recommendations are specific enough to plan subsequent phases
- No ambiguity about what each follow-up phase should implement
</success_criteria>

<output>
After completion, create `.planning/phases/54-exercise-architecture-research/54-01-SUMMARY.md`:

# Phase 54 Plan 01: Exercise Architecture Research Summary

**[One-liner summary of findings]**

## Accomplishments
- [Key findings]

## Files Created
- `DISCOVERY.md` - Exercise architecture analysis and recommendations

## Key Insights
- [Most important discoveries]

## Next Phase Readiness
Phase 54 complete. DISCOVERY.md ready to inform planning for phases 55-58.
</output>
